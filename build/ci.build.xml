<?xml version="1.0"?>
<!-- Continuous integration related targets -->
<project name="Seam2 Continuous Integration Support" basedir="." xmlns:artifact="urn:maven-artifact-ant">

	<property file="default.build.properties" />
	<property file="build.properties" />

	<property name="seam.dir" value="${basedir}/../" />
	<import file="common.build.xml" />

	<property name="snapshots.jboss.org" value="dav:https://snapshots.jboss.org/maven2" />

	<target name="initdav">
		<artifact:install-provider artifactId="wagon-webdav" version="1.0-beta-2" />
	</target>

	<target name="deploySeamSnapshot" description="Deploy a Seam snapshot to snapshots.jboss.org" depends="initdav, initpoms">
		<pomfile name="wagon.pom" value="wagon.pom.xml" />
		<maven target="deploy:deploy-file" basedir=".">
			<arg line="-f ${wagon.pom}" />
			<arg line="-DpomFile=${root.pom}" />
			<arg line="-Dfile=${root.pom}" />
			<arg line="-Durl=${snapshots.jboss.org}" />
			<arg line="-DrepositoryId=snapshots.jboss.org" />
		</maven>
		<deploySnapshotPom pom="${parent.pom}" />
		<deploySnapshot pom="${core.pom}" jar="${lib.dir}/jboss-seam.jar" srcjar="${lib.dir}/src/jboss-seam-sources.jar" />
		<deploySnapshot pom="${debug.pom}" jar="${lib.dir}/jboss-seam-debug.jar" srcjar="${lib.dir}/src/jboss-seam-debug-sources.jar"/>
		<deploySnapshot pom="${gen.pom}" jar="${lib.dir}/jboss-seam-gen.jar" srcjar="${lib.dir}/src/jboss-seam-gen-sources.jar"/>
		<deploySnapshot pom="${ioc.pom}" jar="${lib.dir}/jboss-seam-ioc.jar" srcjar="${lib.dir}/src/jboss-seam-ioc-sources.jar"/>
		<deploySnapshot pom="${mail.pom}" jar="${lib.dir}/jboss-seam-mail.jar" srcjar="${lib.dir}/src/jboss-seam-mail-sources.jar"/>
		<deploySnapshot pom="${pdf.pom}" jar="${lib.dir}/jboss-seam-pdf.jar" srcjar="${lib.dir}/src/jboss-seam-pdf-sources.jar"/>
		<deploySnapshot pom="${remoting.pom}" jar="${lib.dir}/jboss-seam-remoting.jar" srcjar="${lib.dir}/src/jboss-seam-remoting-sources.jar"/>
		<deploySnapshot pom="${ui.pom}" jar="${lib.dir}/jboss-seam-ui.jar" srcjar="${lib.dir}/src/jboss-seam-ui-sources.jar"/>
	</target>

	<target name="tests">
		<build target="cleanall" />
		<build target="coverageall" />
		<build target="copytestoutput" />
		<build target="testreport" />
		<build target="validateall" />
	</target>

	<target name="snapshot">
		<build target="cleanall" />
		<build target="dist" />
		<antcall target="deploySeamSnapshot" />
		<antcall target="tests" />
	</target>

	<macrodef name="build">
		<attribute name="target" />
		<sequential>
			<ant antfile="${seam.dir}/build.xml" target="@{target}" inheritall="false" inheritrefs="false" dir="../">
				<property name="dist.location" value="dist" />
				<property name="qualifier" value="-SNAPSHOT" />
				<property name="quietclean" value="true" />
			</ant>
		</sequential>
	</macrodef>

    <macrodef name="deploySnapshotPom">
      <attribute name="pom" />
      <sequential>
        <artifact:deploy>
          <pom file="@{pom}" />
        </artifact:deploy>
      </sequential>
    </macrodef>
    

	<macrodef name="deploySnapshot">
		<attribute name="pom" />
		<attribute name="jar" />
        <attribute name="srcjar" />
		<sequential>
			<artifact:deploy file="@{jar}">
				<pom file="@{pom}" />
                <attach file="@{srcjar}" classifier="sources" />
			</artifact:deploy>
		</sequential>
	</macrodef>

</project>