<?xml version="1.0" encoding="ISO-8859-1"?>
<!--
JBoss, Home of Professional Open Source
Copyright 2008, Red Hat Middleware LLC, and individual contributors
by the @authors tag. See the copyright.txt in the distribution for a
full listing of individual contributors.

This is free software; you can redistribute it and/or modify it
under the terms of the GNU Lesser General Public License as
published by the Free Software Foundation; either version 2.1 of
the License, or (at your option) any later version.

This software is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public
License along with this software; if not, write to the Free
Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->
<project name="wicket" basedir="." default="build">
	<property name="example.name" value="wicket" />
	<property name="jboss.example.ready.check.url" value="seam-wicket/home.seam" />

	<import file="../build.xml" />

	<target name="test" depends="build, container.properties" description="Run Tests">
		<!-- TODO all of these jboss commands must be optional with checks -->
		<!-- TODO  go get JBoss and extract -->

		<!-- TODO start JBoss -->
		<!-- clean example -->
		<ant antfile="${seam.dir}/examples/${example.name}/build.xml" target="clean" inheritall="false" dir="${seam.dir}/examples/${example.name}" />

		<!-- deploy the example-->
		<antcall target="deploy.example" />

		<!-- execute testng tests -->
		<antcall target="selenium.test" />

		<!-- undeploy the example -->
		<antcall target="undeploy.example" />

		<!-- clean example -->
		<ant antfile="${seam.dir}/examples/${example.name}/build.xml" target="clean" inheritall="false" dir="${seam.dir}/examples/${example.name}" />

		<!-- deploy the example with runtime instrumentation -->
		<antcall target="deploy.example.runtime.instrumentation" />

		<!-- execute testng tests -->
		<antcall target="selenium.test.runtime.instrumentation" />

		<!-- undeploy the example -->
		<antcall target="undeploy.example" />
	</target>

	<target name="deploy.example.runtime.instrumentation" depends="container.properties">
		<property name="absolute.wait.url" value="${selenium.browser.url}${wait.url}" />
		<echo>Deploying ${example.name} example to ${container} using ${deploy.target} target</echo>
		<ant antfile="${seam.dir}/examples/${example.name}/build.xml" target="${deploy.target}" inheritall="false" dir="${seam.dir}/examples/${example.name}">
			<property name="jboss.home" value="${container.home}" />
			<property name="tomcat.home" value="${container.home}" />
			<property name="instrumentAtRunTime" value="true" />
		</ant>
		<!-- wait for the application to be active -->
		<!-- TODO is there a better way? -->
		<echo>Waiting ${wait.time} seconds for ${absolute.wait.url}</echo>
		<waitfor maxwait="${wait.time}" maxwaitunit="second">
			<and>
				<!-- wait for the application to not throw 404 -->
				<http url="${absolute.wait.url}" errorsBeginAt="404" />
			</and>
		</waitfor>
	</target>
	
	<target name="selenium.test.runtime.instrumentation" depends="build, container.properties" description="Run Tests">
		<taskdef resource="testngtasks" classpathref="classpath.test" />
		<mkdir dir="${test.output.dir}" />

		<!-- execute testng tests -->
		<testng haltonfailure="false" outputdir="${test.output.dir}" classpathref="classpath.test">
			<xmlfileset file="${container}-runtime.xml" />
			<sysproperty key="selenium.server.port" value="${selenium.server.port}" />
			<sysproperty key="selenium.host" value="${selenium.host}" />
			<sysproperty key="selenium.browser" value="${selenium.browser}" />
			<sysproperty key="selenium.browser.url" value="${selenium.browser.url}" />
			<sysproperty key="selenium.speed" value="${selenium.speed}" />
			<sysproperty key="selenium.timeout" value="${selenium.timeout}" />
			<sysproperty key="example.context.path" value="${context.path}" />
		</testng>
	</target>

</project>
