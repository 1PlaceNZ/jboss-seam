<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head xmlns="http://www.w3.org/1999/xhtml">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>11.3. Query objects</title>
    <link rel="stylesheet" href="./Common_Content/css/default.css" type="text/css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.72.0" />
    <link rel="start" href="index.html" title="Seam - Contextual Components" />
    <link rel="up" href="framework.html" title="Chapter 11. The Seam Application Framework" />
    <link rel="prev" href="ch11s02.html" title="11.2. Home objects" />
    <link rel="next" href="ch11s04.html" title="11.4. Controller objects" />
  </head>
  <body>
    <p xmlns="http://www.w3.org/1999/xhtml" id="title">
      <a href="http://www.redhat.com/docs">
        <strong>11.3. Query objects</strong>
      </a>
    </p>
    <ul xmlns="http://www.w3.org/1999/xhtml" class="docnav">
      <li class="previous">
        <a accesskey="p" href="ch11s02.html">
          <strong>Prev</strong>
        </a>
      </li>
      <li class="next">
        <a accesskey="n" href="ch11s04.html">
          <strong>Next</strong>
        </a>
      </li>
    </ul>
    <div xmlns="http://www.w3.org/1999/xhtml" class="section" lang="en-US" xml:lang="en-US">
      <div class="titlepage">
        <div>
          <div>
            <h2 class="title"><a id="id2811241"></a>11.3. Query objects</h2>
          </div>
        </div>
      </div>
      <p>
			If we need a list of all <code class="literal">Person</code> instance in the database, we can use a Query object. For example:
		</p>
      <pre class="programlisting">&lt;framework:entity-query name="people" 
                        ejbql="select p from Person p"/&gt;
</pre>
      <p>
			We can use it from a JSF page:
		</p>
      <pre class="programlisting">&lt;h1&gt;List of people&lt;/h1&gt;
&lt;h:dataTable value="#{people.resultList}" var="person"&gt;
    &lt;h:column&gt;
        &lt;s:link view="/editPerson.jsp" value="#{person.firstName} #{person.lastName}"&gt;
            &lt;f:param name="personId" value="#{person.id}"/&gt;
        &lt;/s:link&gt;
    &lt;/h:column&gt;
&lt;/h:dataTable&gt;
</pre>
      <p>
			We probably need to support pagination:
		</p>
      <pre class="programlisting">&lt;framework:entity-query name="people" 
                        ejbql="select p from Person p" 
                        order="lastName" 
                        max-results="20"/&gt;
</pre>
      <p>
			We'll use a page parameter to determine the page to display:
		</p>
      <pre class="programlisting">&lt;pages&gt;
    &lt;page view-id="/searchPerson.jsp"&gt;
        &lt;param name="firstResult" value="#{people.firstResult}"/&gt;
    &lt;/page&gt;
&lt;/pages&gt;
</pre>
      <p>
			The JSF code for a pagination control is a bit verbose, but manageable:
		</p>
      <pre class="programlisting">&lt;h1&gt;Search for people&lt;/h1&gt;
&lt;h:dataTable value="#{people.resultList}" var="person"&gt;
    &lt;h:column&gt;
        &lt;s:link view="/editPerson.jsp" value="#{person.firstName} #{person.lastName}"&gt;
            &lt;f:param name="personId" value="#{person.id}"/&gt;
        &lt;/s:link&gt;
    &lt;/h:column&gt;
&lt;/h:dataTable&gt;

&lt;s:link view="/search.xhtml" rendered="#{people.previousExists}" value="First Page"&gt;
    &lt;f:param name="firstResult" value="0"/&gt;
&lt;/s:link&gt;

&lt;s:link view="/search.xhtml" rendered="#{people.previousExists}" value="Previous Page"&gt;
    &lt;f:param name="firstResult" value="#{people.previousFirstResult}"/&gt;
&lt;/s:link&gt;

&lt;s:link view="/search.xhtml" rendered="#{people.nextExists}" value="Next Page"&gt;
    &lt;f:param name="firstResult" value="#{people.nextFirstResult}"/&gt;
&lt;/s:link&gt;

&lt;s:link view="/search.xhtml" rendered="#{people.nextExists}" value="Last Page"&gt;
    &lt;f:param name="firstResult" value="#{people.lastFirstResult}"/&gt;
&lt;/s:link&gt;
</pre>
      <p>
			Real search screens let the user enter a bunch of optional search criteria to narrow the list of results returned. The Query object lets you specify optional "restrictions" to support this important usecase:
		</p>
      <pre class="programlisting">&lt;component name="examplePerson" class="Person"/&gt;
        
&lt;framework:entity-query name="people" 
                        ejbql="select p from Person p" 
                        order="lastName" 
                        max-results="20"&gt;
    &lt;framework:restrictions&gt;
        &lt;value&gt;lower(firstName) like lower( concat(#{examplePerson.firstName},'%') )&lt;/value&gt;
        &lt;value&gt;lower(lastName) like lower( concat(#{examplePerson.lastName},'%') )&lt;/value&gt;
    &lt;/framework:restrictions&gt;
&lt;/framework:entity-query&gt;
</pre>
      <p>
			Notice the use of an "example" object.
		</p>
      <pre class="programlisting">&lt;h1&gt;Search for people&lt;/h1&gt;
&lt;h:form&gt;
    &lt;div&gt;First name: &lt;h:inputText value="#{examplePerson.firstName}"/&gt;&lt;/div&gt;
    &lt;div&gt;Last name: &lt;h:inputText value="#{examplePerson.lastName}"/&gt;&lt;/div&gt;
    &lt;div&gt;&lt;h:commandButton value="Search" action="/search.jsp"/&gt;&lt;/div&gt;
&lt;/h:form&gt;

&lt;h:dataTable value="#{people.resultList}" var="person"&gt;
    &lt;h:column&gt;
        &lt;s:link view="/editPerson.jsp" value="#{person.firstName} #{person.lastName}"&gt;
            &lt;f:param name="personId" value="#{person.id}"/&gt;
        &lt;/s:link&gt;
    &lt;/h:column&gt;
&lt;/h:dataTable&gt;
</pre>
      <p>
			To refresh the query when the underlying entities change we observe the <code class="literal">org.jboss.seam.afterTransactionSuccess</code> event:
		</p>
      <pre class="programlisting">&lt;event type="org.jboss.seam.afterTransactionSuccess"&gt;
    &lt;action execute="#{people.refresh}" /&gt;
&lt;/event&gt;
</pre>
      <p>
			Or, to just refresh the query when the person entity is persisted, updated or removed through <code class="literal">PersonHome</code>:
		</p>
      <pre class="programlisting">&lt;event type="org.jboss.seam.afterTransactionSuccess.Person"&gt;
    &lt;action execute="#{people.refresh}" /&gt;
    &lt;/event&gt;
</pre>
      <p>
			Unfortunately Query objects don't work well with <span class="emphasis"><em>join fetch</em></span> queries - the use of pagination with these queries is not recomended, and you'll have to implement your own method of calculating the total number of results (by overriding <code class="literal">getCountEjbql()</code>.
		</p>
      <p>
			The examples in this section have all shown reuse by configuration. However, reuse by extension is equally possible for Query objects.
		</p>
    </div>
    <ul xmlns="http://www.w3.org/1999/xhtml" class="docnav">
      <li class="previous">
        <a accesskey="p" href="ch11s02.html"><strong>Prev</strong>11.2. Home objects</a>
      </li>
      <li class="up">
        <a accesskey="u" href="#">
          <strong>Up</strong>
        </a>
      </li>
      <li class="home">
        <a accesskey="h" href="index.html">
          <strong>Home</strong>
        </a>
      </li>
      <li class="next">
        <a accesskey="n" href="ch11s04.html"><strong>Next</strong>11.4. Controller objects</a>
      </li>
    </ul>
  </body>
</html>
