<?xml version="1.0" encoding="UTF-8"?>

<deployment xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="urn:jboss:bean-deployer bean-deployer_1_0.xsd"
    xmlns="urn:jboss:bean-deployer">

    <!-- ###################### JNDI/JTA/JCA ######################## -->

    <!-- Enable a JNDI registry, one per VM -->
    <bean name="Naming" class="org.jnp.server.SingletonNamingServer"/>
    <bean name="InitialContextProperties" class="java.util.Hashtable">
       <constructor>
       <parameter class="java.util.Map">
             <map keyClass="java.lang.String" valueClass="java.lang.String">
                <entry>
                   <key>java.naming.factory.initial</key>
                   <value>org.jnp.interfaces.LocalOnlyContextFactory</value>
                </entry>
                <entry>
                    <key>java.naming.factory.url.pkgs</key>
                    <value>org.jboss.naming:org.jnp.interfaces</value>
                </entry>
             </map>
       </parameter>
       </constructor>
    </bean>

    <!-- Enable JTA available through JNDI (regular JBoss location for TM)-->
    <bean name="TransactionManagerFactory" class="org.jboss.seam.microcontainer.TransactionManagerFactory">
        <property name="initialContextProperties"><inject bean="InitialContextProperties"/></property>
    </bean>
    <bean name="TransactionManager" class="java.lang.Object">
        <constructor factoryMethod="getTransactionManager">
            <factory bean="TransactionManagerFactory"/>
        </constructor>
    </bean>

    <!-- Enable a JCA datasource available through JNDI-->
    <bean name="bookingDataSourceFactory" class="org.jboss.seam.microcontainer.DataSourceFactory">
        <property name="jndiName">java:/noejbDatasource</property>
        <property name="driverClass">org.hsqldb.jdbcDriver</property>
        <property name="connectionUrl">jdbc:hsqldb:.</property>
        <property name="userName">sa</property>
        <property name="minSize">0</property>
        <property name="maxSize">10</property>
        <property name="blockingTimeout">1000</property>
        <property name="idleTimeout">100000</property>
        <property name="transactionManager"><inject bean="TransactionManager"/></property>
        <property name="initialContextProperties"><inject bean="InitialContextProperties"/></property>
    </bean>
    <bean name="bookingDatasource" class="java.lang.Object">
        <constructor factoryMethod="getDataSource">
            <factory bean="bookingDataSourceFactory"/>
        </constructor>
    </bean>

    <!-- ###################### Hibernate service ######################## -->

    <!-- Setup a Hibernate configuration factory -->
    <bean name="HibernateFactory" class="org.jboss.seam.microcontainer.HibernateFactory">
        <property name="cfgProperties">
            <map keyClass="java.lang.String" valueClass="java.lang.String">
                <entry>
                    <key>hibernate.session_factory_name</key>
                    <value>java:/hibernate/bookingDatabase</value>
                </entry>
                <entry>
                    <key>hibernate.connection.datasource</key>
                    <value>java:/noejbDatasource</value>
                </entry>
                <entry>
                    <key>hibernate.dialect</key>
                    <value>org.hibernate.dialect.HSQLDialect</value>
                </entry>
                <entry>
                    <key>hibernate.hbm2ddl.auto</key>
                    <value>create-drop</value>
                </entry>
                <entry>
                    <key>hibernate.cache.provider_class</key>
                    <value>org.hibernate.cache.HashtableCacheProvider</value>
                </entry>
                <entry>
                    <key>hibernate.transaction.flush_before_completion</key>
                    <value>true</value>
                </entry>
                <entry>
                    <key>hibernate.connection.release_mode</key>
                    <value>after_statement</value>
                </entry>
                <entry>
                    <key>hibernate.transaction.manager_lookup_class</key>
                    <value>org.hibernate.transaction.JBossTransactionManagerLookup</value>
                </entry>
                <entry>
                    <key>hibernate.transaction.factory_class</key>
                    <value>org.hibernate.transaction.JTATransactionFactory</value>
                </entry>
                <entry>
                    <key>show_sql</key>
                    <value>false</value>
                </entry>
            </map>
        </property>
        <property name="mappingClasses">
            <list elementClass="java.lang.String">
                <value>org.jboss.seam.example.noejb.Hotel</value>
                <value>org.jboss.seam.example.noejb.User</value>
                <value>org.jboss.seam.example.noejb.Booking</value>
            </list>
        </property>
        <property name="jndiProperties"><inject bean="InitialContextProperties"/></property>
    </bean>

    <!-- Build the Hibernate SessionFactory -->
    <bean name="bookingSessionFactory" class="java.lang.Object">
        <constructor factoryMethod="buildSessionFactory">
            <factory bean="HibernateFactory"/>
        </constructor>
        <!-- First initialize the datasource as a dependency -->
        <depends>bookingDatasource</depends>
    </bean>

</deployment>
