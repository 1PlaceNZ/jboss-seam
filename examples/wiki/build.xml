<?xml version="1.0"?>

<project name="wiki" default="deploy" basedir=".">

	<!-- Give user a chance to override without editing this file or typing -D -->
	<property file="${basedir}/build.properties" />

	<!-- set global properties for this build -->
	<property name="project.name" value="wiki"/>
	<property name="dist.dir" value="dist" />
	<property name="src.java.dir" value="src" />
	<property name="src.test.dir" value="test" />
    <property name="seam.home" value="../../"/>
    <property name="lib.dir"        value="${seam.home}/lib" />
    <property name="seamlibs.dir"   value="${seam.home}"/>
    <property name="drools.lib.dir" value="${seam.home}/drools/lib"/>
    <property name="ear.dir" value="exploded-archives/${project.name}.ear" />
	<property name="jar.dir" value="exploded-archives/${project.name}.jar" />
	<property name="war.dir" value="exploded-archives/${project.name}.war" />
	<property name="test.dir" value="test-build" />
	<property name="embedded-ejb3.dir" value="${basedir}/embedded-ejb/conf" />
	<property name="deploy.dir" value="${jboss.home}/server/default/deploy" />
	<property name="ear.deploy.dir" value="${deploy.dir}/${project.name}.ear" />
	<property name="jar.deploy.dir" value="${ear.deploy.dir}/${project.name}.jar" />
	<property name="war.deploy.dir" value="${ear.deploy.dir}/${project.name}.war" />
	<property name="testng.jar" value="${lib.dir}/testng-4.5.1-jdk15.jar" />
	<property name="javac.debug" value="true" />
	<property name="javac.deprecation" value="false" />
	<property name="profile" value="dev" />

	<fileset id="lib" dir="${lib.dir}">
		<include name="*.jar" />
    </fileset>

    <fileset id="seamlibs" dir="${seamlibs.dir}">
        <include name="jboss-seam*.jar"/>
    </fileset>

    <zipfileset id="droolslibs"
               dir="${drools.lib.dir}">
        <include name="*.jar"/>
    </zipfileset>

    <zipfileset id="jcaptchalibs" dir="${lib.dir}">
        <include name="jcaptcha-all*.jar"/>
    </zipfileset>

    <path id="build.classpath">
		<fileset refid="lib" />
        <fileset refid="seamlibs"/>
	</path>

	<target name="init" description="Initialize the build">
        <mkdir dir="${jar.dir}" />
		<mkdir dir="${ear.dir}" />
		<mkdir dir="${war.dir}" />
		<mkdir dir="${dist.dir}" />
	</target>

	<target name="compile" depends="init" 
			description="Compile the Java source code" 
			unless="eclipse.running">
		<javac classpathref="build.classpath" 
			        destdir="${jar.dir}" 
			          debug="${javac.debug}" 
			    deprecation="${javac.deprecation}" 
			        nowarn="on">
			<src path="${src.java.dir}" />
		</javac>
	</target>

	<target name="jar" depends="compile" 
			description="Build the distribution .jar file">
		<copy todir="${jar.dir}">
			<fileset dir="${basedir}/resources">
				<include name="seam.properties" />
			</fileset>
		</copy>
		<copy todir="${jar.dir}/META-INF">
			<fileset dir="${basedir}/resources/META-INF">
				<include name="ejb-jar.xml" />
                <include name="wiki.taglib.xml" />
			</fileset>
		</copy>
		<copy tofile="${jar.dir}/META-INF/persistence.xml" 
			    file="${basedir}/resources/META-INF/persistence-${profile}.xml"
		   overwrite="true"/>
		<copy tofile="${jar.dir}/import.sql" 
			    file="${basedir}/resources/import-${profile}.sql"
		   overwrite="true"/>
        <!-- Replace @@LF@@ in import.sql with real SQL char(10) linefeed (concat)-->
        <replace file="${jar.dir}/import.sql" token="@@LF@@" value="'+char(10)+'"/>
    </target>

	<target name="war" depends="compile" 
			description="Build the distribution .war file">
		<copy todir="${war.dir}">
			<fileset dir="${basedir}/view" />
		</copy>
		<copy todir="${war.dir}/WEB-INF">
			<fileset dir="${basedir}/resources/WEB-INF">
				<include name="*.*"/>
				<include name="classes/**/*.*"/>
				<exclude name="classes/**/*.class"/>
			</fileset>
			<filterset>
				<filter token="jndiPattern" value="${project.name}/#{ejbName}/local" />
				<filter token="embeddedEjb" value="false" />
			</filterset>
		</copy>		
		<copy todir="${war.dir}/WEB-INF">
			<fileset dir="${basedir}/resources/WEB-INF">
				<include name="lib/*.*"/>
				<include name="classes/**/*.class"/>
			</fileset>
		</copy>		
		<copy todir="${war.dir}/WEB-INF/lib">
			<fileset dir="${lib.dir}">
				<include name="jsf-facelets.jar" />
			</fileset>
            <fileset dir="${seamlibs.dir}">
                <include name="jboss-seam-debug.jar" />
                <include name="jboss-seam-ui.jar" />
                <include name="jboss-seam-mail.jar" />
            </fileset>
        </copy>
		<copy todir="${war.dir}/WEB-INF/classes">
			<fileset dir="${basedir}/resources"> 
				<include name="messages*.properties"/>
			</fileset>
		</copy>
	</target>

	<target name="ear" description="Build the EAR">
		<copy todir="${ear.dir}">
			<fileset dir="${basedir}/resources">
				<include name="*jpdl.xml" />
				<include name="hibernate.cfg.xml" />
				<include name="jbpm.cfg.xml" />
			</fileset>
			<fileset dir="${lib.dir}">
				<include name="jbpm*.jar" />
				<include name="el-*.jar" />
			</fileset>
            <fileset dir="${seamlibs.dir}">
                <include name="jboss-seam.jar" />
            </fileset>
            <fileset refid="droolslibs"/>
            <fileset refid="jcaptchalibs"/>
        </copy>
		<copy todir="${ear.dir}/META-INF">
			<fileset dir="${basedir}/resources/META-INF">
				<include name="application.xml" />
				<include name="jboss-app.xml" />
                <include name="security-rules.drl" />
			</fileset>
		</copy>
	</target>
	
	<target name="archive" depends="jar,war,ear" 
			description="Package the archives">
		<jar jarfile="${dist.dir}/${project.name}.jar" basedir="${jar.dir}"/>
		<jar jarfile="${dist.dir}/${project.name}.war" basedir="${war.dir}"/>
		<jar jarfile="${dist.dir}/${project.name}.ear">
			<fileset dir="${ear.dir}"/>
			<fileset dir="${dist.dir}">
				<include name="${project.name}.jar"/>
				<include name="${project.name}.war"/>
			</fileset>
		</jar>
	</target>
	
	<target name="datasource">
		<fail unless="jboss.home">jboss.home not set</fail>
		<copy todir="${deploy.dir}">
			<fileset dir="${basedir}/resources">
				<include name="${project.name}-${profile}-ds.xml" />
			</fileset>
		</copy>
	</target>
	
	<target name="explode" depends="jar,war,ear,datasource" 
			description="Deploy the exploded archive">
		<fail unless="jboss.home">jboss.home not set</fail>
		
		<mkdir dir="${jar.deploy.dir}"/>
		<mkdir dir="${war.deploy.dir}"/>		
		
		<copy todir="${jar.deploy.dir}">
			<fileset dir="${jar.dir}"/>
		</copy>
		<copy todir="${war.deploy.dir}">
			<fileset dir="${war.dir}"/>
		</copy>
		<copy todir="${ear.deploy.dir}">
			<fileset dir="${ear.dir}"/>
		</copy>
	</target>

	<target name="unexplode" description="Undeploy the exploded archive">
		<delete failonerror="no">
			<fileset dir="${ear.deploy.dir}">
				<exclude name="**/*.jar"/>
			</fileset>
		</delete>
		<delete file="${deploy.dir}/${project.name}-ds.xml" failonerror="no"/>
		<delete dir="${ear.deploy.dir}" failonerror="no"/>
	</target>
	
	<target name="restart" depends="explode" description="Restart the exploded archive">
		<touch file="${ear.deploy.dir}/META-INF/application.xml"/>
	</target>

	<target name="deploy" depends="archive,datasource" description="Deploy to JBoss AS">
		<fail unless="jboss.home">jboss.home not set</fail>
		<copy todir="${deploy.dir}" file="${dist.dir}/${project.name}.ear" />
	</target>

	<target name="undeploy" description="Undeploy the example from JBoss">
		<delete file="${deploy.dir}/${project.name}.ear" />
		<delete file="${deploy.dir}/${project.name}-dev-ds.xml" />
		<delete file="${deploy.dir}/${project.name}-prod-ds.xml" />
	</target>

	<target name="clean" description="Cleans up the build directory">
		<delete dir="${dist.dir}" />
		<delete dir="${test.dir}" />
		<delete dir="${ear.dir}" />
		<delete dir="${war.dir}" />
		<delete>
			<fileset dir="${jar.dir}">
				<exclude name="**/*.class" if="eclipse.running"/>
			</fileset>
		</delete>
	</target>

	<target name="test" depends="jar,war,ear" description="Run the tests">

        <mkdir dir="${test.dir}"/>
        <javac classpathref="build.classpath"
                        destdir="${test.dir}"
                          debug="${javac.debug}"
                    deprecation="${javac.deprecation}"
                        nowarn="on">
                <src path="${src.java.dir}" />
                <src path="${src.test.dir}" />
        </javac>
		<copy todir="${test.dir}">
			<fileset dir="${basedir}/resources" />
		</copy>
		<copy todir="${test.dir}" flatten="true">
			<fileset dir="${src.test.dir}">
				<include name="**/*Test.xml" />
			</fileset>
		</copy>
		
		<taskdef resource="testngtasks" classpath="${testng.jar}" />
		<testng outputdir="${basedir}/testng-report">
			<classpath path="${test.dir}" />
			<classpath path="${embedded-ejb3.dir}" />
			<classpath refid="build.classpath" />
			<xmlfileset dir="${test.dir}" includes="*Test.xml" />
		</testng>
		
	</target>

    <!-- Database schema export -->
    <path id="tools.classpath">
        <fileset dir="../../seam-gen/lib">
            <include name="*.jar"/>
        </fileset>
        <fileset dir="../../hibernate/lib">
            <include name="*.jar"/>
        </fileset>
        <fileset dir="../../lib">
            <include name="thirdparty*.jar"/>
        </fileset>
    </path>

    <taskdef name="hibernatetool"
             classname="org.hibernate.tool.ant.HibernateToolTask"
             classpathref="tools.classpath"/>

    <target name="schemaexport" depends="jar"
        description="Exports a generated schema to a file">

        <hibernatetool destdir="${basedir}">
            <classpath path="${jar.dir}"/>
            <jpaconfiguration/> <!-- Use META-INF/persistence.xml -->
            <hbm2ddl
                drop="false"
                create="true"
                export="false"
                outputfilename="${dist.dir}/wiki-ddl.sql"
                delimiter=";"
                format="true"/>
        </hibernatetool>
        <echo message="Exported DDL to file: ${dist.dir}/wiki-ddl.sql"/>
    </target>

</project>
