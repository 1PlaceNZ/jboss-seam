<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE pages PUBLIC "-//Seam/Seam Pages DTD 1.1//EN" "http://jboss.com/products/seam/pages-1.1.dtd">

<pages login-view-id="/loginRequired.xhtml">

    <page view-id="/display.xhtml" action="#{browser.prepare}">
        <param name="nodeId" value="#{browser.nodeId}"/>

        <end-conversation/>

        <navigation>
            <rule if="#{!empty currentDocument}">
                <render view-id="/docDisplay.xhtml"/>
            </rule>
            <rule>
                <render view-id="/dirDisplay.xhtml"/>
            </rule>
        </navigation>
    </page>

    <page view-id="/docDisplay.xhtml" action="#{browser.prepare}">
        <param name="nodeId" value="#{browser.nodeId}"/>

        <end-conversation/>

        <navigation>
            <rule if-outcome="createDoc">
                <redirect view-id="/docEdit.xhtml">
                    <param name="parentDirId" value="#{currentDirectory.id}"/>
                </redirect>
            </rule>
            <rule if-outcome="editDoc">
                <redirect view-id="/docEdit.xhtml">
                    <param name="docId"         value="#{currentDocument.id}"/>
                    <param name="parentDirId"   value="#{currentDirectory.id}"/>
                </redirect>
            </rule>
            <rule if-outcome="browseDir">
                <render view-id="/dirDisplay.xhtml"/>
            </rule>
        </navigation>

    </page>

    <page view-id="/docEdit.xhtml" login-required="true">
        <restrict/>
        <navigation from-action="#{documentHome.remove}">
            <end-conversation/>
            <redirect view-id="/display.xhtml">
                <param name="nodeId" value="#{currentDirectory.id}"/>
            </redirect>
        </navigation>
    </page>

    <page view-id="/dirDisplay.xhtml" action="#{browser.prepare}">
        <param name="nodeId" value="#{browser.nodeId}"/>

        <end-conversation/>

        <navigation>
            <rule if-outcome="createDir">
                <redirect view-id="/dirEdit.xhtml">
                    <param name="parentDirId" value="#{currentDirectory.id}"/>
                </redirect>
            </rule>
            <rule if-outcome="editDir">
                <redirect view-id="/dirEdit.xhtml">
                    <param name="dirId" value="#{currentDirectory.id}"/>
                </redirect>
            </rule>
            <rule if-outcome="createDoc">
                <redirect view-id="/docEdit.xhtml">
                    <param name="parentDirId" value="#{currentDirectory.id}"/>
                </redirect>
            </rule>
        </navigation>

    </page>

    <page view-id="/dirEdit.xhtml" login-required="true">
        <restrict/>
        <navigation from-action="#{directoryHome.remove}">
            <rule if="#{!empty directoryHome.parentDirectory}">
                <end-conversation/>
                <redirect view-id="/dirDisplay.xhtml">
                    <param name="nodeId" value="#{directoryHome.parentDirectory.id}"/>
                </redirect>
            </rule>
            <rule>
                <end-conversation/>
                <redirect view-id="/dirDisplay.xhtml">
                    <param name="nodeId" value="#{wikiRoot.id}"/>
                </redirect>
            </rule>
        </navigation>

    </page>

    <!-- Global actions -->

    <page view-id="/*">
        <navigation>
            <rule if-outcome="register">
                <redirect view-id="/profile.xhtml"/>
            </rule>
            <rule if-outcome="editMyProfile">
                <redirect view-id="/profile.xhtml">
                    <param name="userId" value="#{authenticatedUser.id}"/>
                </redirect>
            </rule>

            <rule if-outcome="error">
                <redirect view-id="/message.xhtml">
                    <message severity="ERROR">An unrecoverable error occured!</message>
                </redirect>
            </rule>
        </navigation>

    </page>

    <!-- Special pages -->

    <page view-id="/confirmRegistration.xhtml" action="#{authenticator.activate}">
        <navigation>
            <rule if-outcome="activated">
                <redirect view-id="/message.xhtml">
                    <message severity="INFO">Your account has been activated, please log in.</message>
                </redirect>
            </rule>
            <rule if-outcome="notFound">
                <redirect view-id="/message.xhtml">
                    <message severity="ERROR">Your activation code is invalid.</message>
                </redirect>
            </rule>
        </navigation>
    </page>

    <!-- These effectively "block" the user from navigating forward, he stays on the last browsed page and
         gets an error message. -->
    <page view-id="/loginRequired.xhtml" action="#{browser.redirectToLastBrowsedPageWithConversation}"/>
    <page view-id="/permissionError.xhtml" action="#{browser.redirectToLastBrowsedPageWithConversation}"/>
    
    <exception class="org.jboss.seam.security.AuthorizationException">
        <end-conversation/>
        <redirect view-id="/permissionError.xhtml">
            <message severity="WARN">You do not have permission for this operation</message>
        </redirect>
    </exception>

</pages>


