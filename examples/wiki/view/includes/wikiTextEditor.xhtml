<s:fragment
        xmlns:s="http://jboss.com/products/seam/taglib"
        xmlns:ui="http://java.sun.com/jsf/facelets"
        xmlns:f="http://java.sun.com/jsf/core"
        xmlns:h="http://java.sun.com/jsf/html"
        xmlns:a="https://ajax4jsf.dev.java.net/ajax"
        xmlns:wiki="http://jboss.com/products/seam/wiki">

<!-- TODO: Most of this Javascript could be made generic and not rendered for each and every
     text editor on the page (luckily we usually have just one)... -->

<script type="text/javascript" src="#{basePath}/seam/resource/remoting/interface.js?wikiTextEditor"></script>
<script type="text/javascript">
    Seam.Remoting.getContext().setConversationId('#{conversation.id}');

    /* Set text area resize on backing bean */
    var wikiTextEditor = Seam.Component.getInstance("wikiTextEditor");
    function storeTextAreaRows(editorId, textAreaRows) {
        /* TODO: Causes seam/hibernate passivation version mismatch errors if followed by an AJAX request, disabled.
        wikiTextEditor.setTextAreaRows(editorId, textAreaRows, noopCallback);
        */
    }
    function noopCallback() {}
</script>

<s:div styleClass="entry" id="#{textEditorId}TextEditor" style="margin-bottom:10px;">

    <script type="text/javascript">
    if(!jQuery.browser.safari &amp;&amp; !jQuery.browser.msie){

        /* Assign resize handle to text area */
        jQuery(function() {
            jQuery("##{namingContainer}\\:#{textEditorId}TextEditDiv").Resizable({
                minHeight: 50,
                handlers: {
                    s: '##{namingContainer}\\:#{textEditorId}TextEditResizeHandle'
                },
                onResize: function(size) {
                    jQuery("##{namingContainer}\\:#{textEditorId}TextArea").attr("rows", Math.floor(size.height/15));
                    jQuery("##{namingContainer}\\:#{textEditorId}TextArea").css({ height: size.height + "px" });
                },
                onStop: function() {
                    storeTextAreaRows('#{textEditorId}', jQuery("##{namingContainer}\\:#{textEditorId}TextArea").attr('rows'));
                }
            });
            jQuery("##{namingContainer}\\:#{textEditorId}TextEditResizeHandle").show();
        })
    };
    </script>

    <s:div id="#{textEditorId}MessageLabel"
            styleClass="#{wiki:hasMessage(namingContainer, wiki:concat(textEditorId, 'TextArea'))?'label errorEntry':'label'}">

        <s:div>
            <h:outputText value="#{label}:"/>
            <s:fragment rendered="#{not empty textPreviewId}">
                <br/>
                <h:outputText value="(#{valueMaxLength - wiki:length(valueBinding)} #{messages['lacewiki.label.wikiTextEditor.CharactersLeft']})"/>
            </s:fragment>
        </s:div>

        <s:div styleClass="errorMessage" rendered="#{wiki:hasMessage(namingContainer, wiki:concat(textEditorId, 'TextArea'))}">
            <h:panelGrid columns="2" cellpadding="0" cellspacing="0" border="0">
                <h:graphicImage value="/themes/#{preferences.get('Wiki').themeName}/img/attention.gif"
                                width="18" height="18"
                                styleClass="attentionImage"/>
                <s:span styleClass="attentionMessage">&#160;<span id="#{textEditorId}MessageText"><h:message for="#{textEditorId}TextArea"/></span></s:span>
            </h:panelGrid>
        </s:div>

        <s:fragment rendered="#{!empty tabId}">
            <s:span rendered="#{wiki:hasMessage(namingContainer, wiki:concat(textEditorId, 'TextArea'))}">
                <script type="text/javascript">jQuery(function() {
                    formTabRaiseError("#{tabId}", "#{textEditorId}TextArea", '#{label}:&#160;' + jQuery("##{textEditorId}MessageText").html());
                });</script>
            </s:span>
            <s:span rendered="#{!wiki:hasMessage(namingContainer, wiki:concat(textEditorId, 'TextArea'))}">
                <script type="text/javascript">jQuery(function() {
                    formTabClearError("#{tabId}", "#{textEditorId}TextArea");
                });</script>
            </s:span>
        </s:fragment>

    </s:div>

    <div class="input">

        <s:validateAll>

            <s:div id="#{textEditorId}TextEditDiv" styleClass="textEditResizable">

                <h:panelGrid columns="2" cellpadding="0" cellspacing="0" border="0"
                             columnClasses="textArea, textAreaHelp">

                    <h:inputTextarea id="#{textEditorId}TextArea"
                                     styleClass="ajaxSupport"
                                     tabindex="1"
                                     cols="#{empty textEditorColumns ? '58' : textEditorColumns}"
                                     rows="#{not empty wikiTextEditor.getTextAreaRows(textEditorId)
                                             ? wikiTextEditor.getTextAreaRows(textEditorId)
                                             : textEditorRows}"
                                     required="#{valueRequired}"
                                     value="#{valueBinding}">
                        <a:support event="onkeyup"
                                   action="#{wikiTextEditor.validate(textEditorId, valueBinding)}"
                                   reRender="#{textEditorId}MessageLabel, #{textPreviewId}"
                                   status="#{statusId}"
                                   ignoreDupResponses="true"
                                   requestDelay="3000"
                                   ajaxSingle="true"
                                   eventsQueue="ajaxEventQueue"
                                   oncomplete="onAjaxRequestComplete()"
                                   rendered="#{not empty textPreviewId}"/>
                    </h:inputTextarea>

                    <ui:decorate template="helpPopupButton.xhtml">
                        <ui:param name="label"        value="#{messages['lacewiki.button.help.Help']}"/>
                        <ui:param name="width"        value="450"/>
                        <ui:param name="height"       value="350"/>
                        <ui:param name="offsetId"     value="#{namingContainer}\\\\:#{textEditorId}TextEditDiv"/>
                        <ui:param name="helpDocument" value="Wiki Text Markup"/>
                     </ui:decorate>

                </h:panelGrid>

                <s:div id="#{textEditorId}TextEditResizeHandle" styleClass="textEditResizeHandle" style="display:none;"/>
            </s:div>

        </s:validateAll>

    </div>
</s:div>

</s:fragment>

