<s:fragment
        xmlns:s="http://jboss.com/products/seam/taglib"
        xmlns:ui="http://java.sun.com/jsf/facelets"
        xmlns:f="http://java.sun.com/jsf/core"
        xmlns:h="http://java.sun.com/jsf/html"
        xmlns:a="https://ajax4jsf.dev.java.net/ajax"
        xmlns:wiki="http://jboss.com/products/seam/wiki">

<!-- TODO: Most of this Javascript could be made generic and not rendered for each and every
     text editor on the page (luckily we usually have just one)... -->

<s:div styleClass="entry" id="#{textEditorId}TextEditor">

    <script type="text/javascript">
    if(jQuery.browser.mozilla){
        jQuery(function() {
            jQuery("##{namingContainer}\\:#{textEditorId}TextAreaDiv").Resizable({
                minHeight: 50,
                minWidth: 250,
                handlers: {
                    se: '##{namingContainer}\\:#{textEditorId}TextEditResizeHandle'
                },
                onResize: function(size) {
                    jQuery("##{namingContainer}\\:#{textEditorId}TextArea").css({ height: size.height-15 + "px" });
                    jQuery("##{namingContainer}\\:#{textEditorId}TextArea").css({ width: size.width-10 + "px" });
                }
            });
            jQuery("##{namingContainer}\\:#{textEditorId}TextEditResizeHandle").show();
        })
    };
    </script>

    <s:div id="#{textEditorId}MessageLabel"
            styleClass="#{wiki:hasMessage(namingContainer, wiki:concat(textEditorId, 'TextArea'))?'label errorEntry':'label'}">

        <s:div>
            <h:outputText value="#{label}:"/>
            <s:fragment rendered="#{not empty textPreviewId}">
                <br/>
                <h:outputText style="white-space:nowrap;"
                              value="(#{valueMaxLength - valueBinding.length()} #{messages['lacewiki.label.wikiTextEditor.CharactersLeft']})"/>
            </s:fragment>
        </s:div>

        <s:div styleClass="errorMessage" rendered="#{wiki:hasMessage(namingContainer, wiki:concat(textEditorId, 'TextArea'))}">
            <h:panelGrid columns="2" cellpadding="0" cellspacing="0" border="0">
                <h:graphicImage value="#{themePath}/img/attention.gif"
                                width="18" height="18"
                                styleClass="attentionImage"/>
                <s:span styleClass="attentionMessage">&#160;<span id="#{textEditorId}MessageText"><h:message for="#{textEditorId}TextArea"/></span></s:span>
            </h:panelGrid>
        </s:div>

        <s:fragment rendered="#{!empty tabId}">
            <s:span rendered="#{wiki:hasMessage(namingContainer, wiki:concat(textEditorId, 'TextArea'))}">
                <script type="text/javascript">jQuery(function() {
                    formTabRaiseError("#{tabId}", "#{textEditorId}TextArea", '#{label}:&#160;' + jQuery("##{textEditorId}MessageText").html());
                });</script>
            </s:span>
            <s:span rendered="#{!wiki:hasMessage(namingContainer, wiki:concat(textEditorId, 'TextArea'))}">
                <script type="text/javascript">jQuery(function() {
                    formTabClearError("#{tabId}", "#{textEditorId}TextArea");
                });</script>
            </s:span>
        </s:fragment>

    </s:div>

    <div class="input">

        <s:validateAll>

            <h:panelGrid columns="1" cellpadding="0" cellspacing="0" border="0">

                <h:panelGrid columns="3" cellpadding="0" cellspacing="0" border="0">

                    <s:fragment>
                        <select id="#{textEditorId}Formatter"
                                onchange="formatText(
                                            jQuery('##{namingContainer}\\:#{textEditorId}TextArea')[0],
                                            jQuery('##{textEditorId}Formatter')[0].options[jQuery('##{textEditorId}Formatter')[0].selectedIndex].value
                                          );
                                          #{textEditorId}RefreshPreview();
                                          jQuery('##{textEditorId}Formatter')[0].options[0].selected = true;">
                            <option value="">#{messages['lacewiki.msg.wikiTextEditor.FormatSelection']}</option>
                            <option value="">#{messages['lacewiki.msg.wikiTextEditor.FormatInline']}</option>
                            <option value="|{i}|">#{messages['lacewiki.msg.wikiTextEditor.FormatMonospace']}</option>
                            <option value="*{i}*">#{messages['lacewiki.msg.wikiTextEditor.FormatEmphasis']}</option>
                            <option value="_{i}_">#{messages['lacewiki.msg.wikiTextEditor.FormatUnderline']}</option>
                            <option value="~{i}~">#{messages['lacewiki.msg.wikiTextEditor.FormatStrikeout']}</option>
                            <option value="^{i}^">#{messages['lacewiki.msg.wikiTextEditor.FormatSuperscript']}</option>
                            <option value="&quot;{i}&quot;">#{messages['lacewiki.msg.wikiTextEditor.FormatQuote']}</option>
                            <option value="[My Link=>{i}]">#{messages['lacewiki.msg.wikiTextEditor.FormatLink']}</option>
                            <option value="">#{messages['lacewiki.msg.wikiTextEditor.FormatBlock']}</option>
                            <option value="`{b}`">#{messages['lacewiki.msg.wikiTextEditor.FormatCodeBlock']}</option>
                            <option value="&quot;{b}&quot;">#{messages['lacewiki.msg.wikiTextEditor.FormatQuoteBlock']}</option>
                            <option value="= {b}">#{messages['lacewiki.msg.wikiTextEditor.FormatUnorderedList']}</option>
                            <option value="# {b}">#{messages['lacewiki.msg.wikiTextEditor.FormatOrderedList']}</option>
                            <option value="+ {b}">#{messages['lacewiki.msg.wikiTextEditor.FormatHeadline1']}</option>
                            <option value="++ {b}">#{messages['lacewiki.msg.wikiTextEditor.FormatHeadline2']}</option>
                            <option value="+++ {b}">#{messages['lacewiki.msg.wikiTextEditor.FormatHeadline3']}</option>
                            <option value="++++ {b}">#{messages['lacewiki.msg.wikiTextEditor.FormatHeadline4']}</option>
                        </select>

                        <a:jsFunction name="#{textEditorId}RefreshPreview" status="globalStatus"
                                      reRender="#{textEditorId}MessageLabel, #{textPreviewId}"/>
                    </s:fragment>

                    <ui:decorate template="helpPopupButton.xhtml">
                        <ui:param name="label"        value="#{messages['lacewiki.button.help.Help']}"/>
                        <ui:param name="width"        value="450"/>
                        <ui:param name="height"       value="350"/>
                        <ui:param name="offsetId"     value="#{namingContainer}\\\\:#{textEditorId}TextAreaDiv"/>
                        <ui:param name="helpDocument" value="Wiki Text Markup"/>
                     </ui:decorate>

                    <s:fragment>
                        <s:fragment rendered="#{not empty textPreviewId}">
                            <h:outputLink value="#"
                                          tabindex="1" styleClass="buttonNonpersistent noWrapWhitespace"
                                          accesskey="#{messages['lacewiki.button.wikiTextEditor.UpdatePreview.accesskey']}"
                                          onclick="rememberCursorPosition('##{namingContainer}\\\\:#{textEditorId}TextArea'); #{textEditorId}UpdatePreview(); return false;">
                                <h:outputText styleClass="buttonLabel" escape="false" value="#{messages['lacewiki.button.wikiTextEditor.UpdatePreview']}"/>
                          </h:outputLink>

                          <a:jsFunction name="#{textEditorId}UpdatePreview"
                                        action="#{wikiTextEditor.validate(textEditorId, valueBinding)}"
                                        status="globalStatus"
                                        reRender="#{textEditorId}MessageLabel, #{textPreviewId}"
                                        eventsQueue="ajaxEventQueue"
                                        oncomplete="onAjaxRequestComplete();setRememberedCursorPosition('##{namingContainer}\\\\:#{textEditorId}TextArea');"/>
                        </s:fragment>
                    </s:fragment>

                </h:panelGrid>

                <s:div id="#{textEditorId}TextAreaDiv" styleClass="textEditResizable">

                    <h:inputTextarea id="#{textEditorId}TextArea"
                                     styleClass="ajaxSupport"
                                     tabindex="1"
                                     cols="#{empty textEditorColumns ? '58' : textEditorColumns}"
                                     rows="#{textEditorRows}"
                                     required="#{valueRequired}"
                                     value="#{valueBinding}">
                        <a:support event="onkeyup"
                                   action="#{wikiTextEditor.validate(textEditorId, valueBinding)}"
                                   reRender="#{textEditorId}MessageLabel, #{textPreviewId}"
                                   status="globalStatus"
                                   ignoreDupResponses="true"
                                   requestDelay="3000"
                                   ajaxSingle="true"
                                   eventsQueue="ajaxEventQueue"
                                   oncomplete="onAjaxRequestComplete()"
                                   rendered="#{not empty textPreviewId}"/>
                    </h:inputTextarea>

                    <s:div id="#{textEditorId}TextEditResizeHandle" styleClass="textEditResizeHandle" style="display:none;float:right;"/>
                </s:div>

            </h:panelGrid>

        </s:validateAll>

    </div>
</s:div>

</s:fragment>

