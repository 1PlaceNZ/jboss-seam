<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:s="http://jboss.com/products/seam/taglib"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:a="https://ajax4jsf.dev.java.net/ajax"
                xmlns:wiki="http://jboss.com/products/seam/wiki"
                template="themes/#{wikiPreferences.themeName}/template.xhtml">

<ui:define name="screenname">
    <h:outputText value="#{messages['lacewiki.label.docHistory.DocumentHistory']} #{nodeHistory.currentNode.name}"/>
</ui:define>

<ui:define name="controlTwo">

    <s:link id="close" styleClass="linkNavigation" action="exit"
            accesskey="#{messages['lacewiki.button.Close.accesskey']}">
        <h:outputText escape="false" value="#{messages['lacewiki.button.Close']}"/>
    </s:link>

</ui:define>

<ui:define name="content">

<h:form rendered="#{historicalNodeList.rowCount >0}" styleClass="box">

<div class="form">
    <div class="formHead">#{messages['lacewiki.label.docHistory.DocumentHistory']}: #{nodeHistory.currentNode.name}</div>
    <div class="formFields formBorder">

        <s:div styleClass="entry">
            <div class="label">#{messages['lacewiki.label.docHistory.CurrentRevision']}:</div>
            <div class="output">
                <h:outputText value="#{nodeHistory.currentNode.revision}"/>
            </div>
        </s:div>

        <s:div styleClass="entry">
            <div class="label">#{messages['lacewiki.label.docHistory.Parent']}:</div>
            <div class="output">
                <h:outputText value="#{nodeHistory.currentNode.parent.name}"/>
            </div>
        </s:div>

        <s:div styleClass="entry">
            <div class="label">#{messages['lacewiki.label.docHistory.CreatedOn']}:</div>
            <div class="output">
                <h:outputText value="#{nodeHistory.currentNode.createdOn}">
                    <f:convertDateTime type="both" timeZone="#{wikiPreferences.timeZone}"/>
                </h:outputText>
                (#{nodeHistory.currentNode.createdBy.username})
            </div>
        </s:div>

        <s:div styleClass="entry" rendered="#{!empty nodeHistory.currentNode.lastModifiedBy}">
            <div class="label">#{messages['lacewiki.label.docHistory.LastModifiedOn']}:</div>
            <div class="output">
                <h:outputText value="#{nodeHistory.currentNode.lastModifiedOn}">
                    <f:convertDateTime type="both" timeZone="#{wikiPreferences.timeZone}"/>
                </h:outputText>
                (#{nodeHistory.currentNode.lastModifiedBy.username})
            </div>
        </s:div>

        <s:div styleClass="entry">
            <div class="label">#{messages['lacewiki.label.docHistory.HistoricalRevisions']}:</div>
            <div class="input">

                <h:dataTable id="historyTable" var="hnode" style="width:50%"
                             value="#{historicalNodeList}"
                             styleClass="datatable topLeftBottomBorder"
                             columnClasses="onePercentColumn rightBorder alignCenter,
                                            twentyPercentColumn rightBorder alignLeft,
                                            twentyPercentColumn rightBorder alignCenter"
                             rowClasses="rowEven, rowOdd"
                             cellpadding="0" cellspacing="0" border="0">

                    <h:column>
                        #{hnode.revision}
                    </h:column>

                    <h:column>
                        <h:outputText value="#{hnode.lastModifiedOn}">
                            <f:convertDateTime type="both" timeZone="#{wikiPreferences.timeZone}"/>
                        </h:outputText>
                        <h:outputText value="&#160;(#{hnode.lastModifiedByUsername})" rendered="#{!empty hnode.lastModifiedByUsername}"/>
                        <h:outputText value="&#160;(unknown)" rendered="#{empty hnode.lastModifiedByUsername}"/>
                    </h:column>

                    <h:column>
                        <a:commandLink id="show"
                                       action="#{nodeHistory.displayHistoricalRevision}"
                                       reRender="messageBoxContainer, diffResult, historicalPreview"
                                       tabindex="3" styleClass="buttonNonpersistent">
                            <h:outputText styleClass="buttonLabel" value="#{messages['lacewiki.button.docHistory.Show']}"/>
                        </a:commandLink>
                        <s:link id="diff" action="#{nodeHistory.diff}" tabindex="3" styleClass="buttonNonpersistent">
                            <h:outputText styleClass="buttonLabel" value="#{messages['lacewiki.button.docHistory.Diff']}"/>
                            <f:param name="historicalNodeId" value="#{hnode.historyId}"/>
                        </s:link>
                        <h:commandLink id="rollback"
                                       action="#{nodeHistory.rollback}"
                                       tabindex="4" styleClass="buttonNonpersistent"
                                       rendered="#{s:hasPermission('Node', 'edit', nodeHistory.currentNode)}">
                            <h:outputText styleClass="buttonLabel" value="#{messages['lacewiki.button.docHistory.Rollback']}"/>
                        </h:commandLink>
                    </h:column>

                </h:dataTable>

            </div>
        </s:div>

    </div>

    <div class="formControls">
        <s:fragment rendered="#{s:hasPermission('User', 'isAdmin', currentUser)}">
            <div class="entry">
                <div class="label">&#160;</div>
                <div class="input">

                    <h:commandLink id="purge" action="#{nodeHistory.purgeHistory}"
                               tabindex="4" accesskey="#{messages['lacewiki.button.docHistory.PurgeHistory.accesskey']}" 
                               styleClass="button">
                        <h:outputText styleClass="buttonLabel" escape="false" value="#{messages['lacewiki.button.docHistory.PurgeHistory']}"/>
                    </h:commandLink>
    
                </div>
            </div>
        </s:fragment>
    </div>

</div>
</h:form>

<br/>

<s:div id="diffResult">
    <s:div styleClass="box diffOutput" rendered="#{not empty nodeHistory.diffResult}">
        <script type="text/javascript">jQuery(function() {
            wrapBoxes();
        });</script>
        <h:outputText value="#{nodeHistory.diffResult}" escape="false"/>
    </s:div>
</s:div>

<s:div id="historicalPreview">
    <s:div id="documentDisplayContainer"
           rendered="#{not empty nodeHistory.displayedHistoricalNode}"
           styleClass="box">
        <script type="text/javascript">jQuery(function() {
            wrapBoxes();
        });</script>
        <s:div id="documentDisplay" styleClass="documentDisplay">
            <wiki:formattedText value="#{nodeHistory.displayedHistoricalNode.content}"
                                linkStyleClass="regularLink"
                                brokenLinkStyleClass="brokenLink"
                                attachmentLinkStyleClass="regularLink"
                                thumbnailLinkStyleClass="regularLink"
                                renderBaseDocument="#{nodeHistory.currentNode}"
                                renderBaseDirectory="#{nodeHistory.currentNode.parent}"
                                enablePlugins="false"/>
        </s:div>
    </s:div>
</s:div>


</ui:define>

<ui:define name="footer">&#160;</ui:define>

</ui:composition>

