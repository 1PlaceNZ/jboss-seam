<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:j4j="http://javascript4jsf.dev.java.net/"
      xmlns:wiki="http://jboss.com/products/seam/wiki"
      xmlns:s="http://jboss.com/products/seam/taglib">

<f:view contentType="text/html"/>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>LaceWiki&#160;-&#160;
        <ui:insert name="screenname"/>
    </title>
    <link href="#{themePath}/css/template.css" rel="stylesheet" type="text/css"/>
    <ui:insert name="includeHeaders"/>

    <script type="text/javascript" src="#{themePath}/js/jquery.js"></script>
    <script type="text/javascript" src="#{themePath}/js/interface.js"></script>
    <script type="text/javascript" src="#{themePath}/js/jqModal.js"></script>
    <script type="text/javascript" src="#{themePath}/js/jqTabs.js"></script>
    <script type="text/javascript" src="#{themePath}/js/jqHistoryRemote.js"></script>
    <script type="text/javascript">

        // ###################### jQuery Integration #################################

        jQuery.noConflict(); // Avoid conflicts with the RichFaces/Prototype library

        function jsf(id) {
            // Find the dynamic JSF client identifier by looking up
            // the static identifier of its j4j proxy child element
            var realId = document.getElementById(id).title;
            var element = document.getElementById(realId);
            return jQuery(element);
        }

        // ###################### Form helpers #################################

        function clickClear(thisfield, defaulttext) {
            if (thisfield.value == defaulttext) {
                thisfield.value = "";
            }
        }
        function clickRecall(thisfield, defaulttext) {
            if (thisfield.value == '') {
                thisfield.value = defaulttext;
            }
        }

        // ###################### Popups #################################

        var fadeInPopupDialog = function(hash) {
            hash.w.fadeIn('fast',function(){ hash.o.show(); });
            jQuery(".closeDialog", hash.w).attr("accesskey", "C"); // Dynamically assign accesskey to .closeDialog buttons
        };

        var fadeOutPopupDialog = function(hash) { hash.w.fadeOut('fast',function(){ hash.o.remove(); }); };

        // ###################### Tabbed Forms #################################

        var formTabErrors = {};

        function formTabRaiseError(tabId, fieldId, message) {

            formTabClearError(tabId, fieldId); // Clear error then re-add

            //alert("Raise error for tab: '" + tabId + "' field: " + fieldId);

            // Add an error message on the form message box

            //alert("Adding error message: " +tabId + fieldId + "ErrorMessage")
            jQuery("#formMessageTable").append(
                '&lt;tr id="' + tabId + fieldId + 'ErrorMessage">&lt;td>&lt;img src="#{themePath}/img/attention.gif" ' +
                'height="18" width="18" class="attentionImage"/>&lt;/td>' +
                '&lt;td>&lt;span id="attentionMessage" class="attentionMessage">'+ message + '&lt;/span>&lt;/td>&lt;/tr>'
            );

            if (formTabErrors[tabId] == null) {
                formTabErrors[tabId] = 1;
            } else {
                formTabErrors[tabId]++;
            }
            formTabRenderErrors(tabId);
        }

        function formTabClearError(tabId, fieldId) {
            if (document.getElementById(tabId+fieldId+"ErrorMessage") != null) { // This error is displayed
                //alert("Clear error for tab: '" + tabId + "' field: " + fieldId);
                //alert("Removing error message: " +tabId + fieldId + "ErrorMessage")
                jQuery("#"+tabId + fieldId + "ErrorMessage").remove();  // Remove the error message on the form message box
                formTabErrors[tabId]--;
                formTabRenderErrors(tabId);
            }
        }

        function formTabRenderErrors(tabId) {
            //alert("Errors for tab: '" + tabId + "': " + formTabErrors[tabId]);

            if (formTabErrors[tabId] > 0 &amp;&amp; document.getElementById(tabId+"InvalidIcon") == null) {
                //alert("Showing icon for tab: " + tabId);
                // Show an icon on the tab and blink it a few times
                jQuery("#"+tabId)
                    .Pulsate(100,5)
                    .prepend('&lt;img id="' + tabId + 'InvalidIcon" ' +
                            'src="#{themePath}/img/attention.gif" width="13" height="13" ' +
                            'alt="!" style="vertical-align:bottom;margin-left:5px;margin-right:5px;"/>');
            } else if (formTabErrors[tabId] &lt; 1){
                //alert("Removing icon of tab: " + tabId);
                jQuery("#"+tabId + "InvalidIcon").remove();             // Remove the error icon on the tab
            }

            var tabsHaveErrors = false;
            for (var tab in formTabErrors) {
                var numOfErrors = formTabErrors[tab];
                if (numOfErrors > 0) {
                    tabsHaveErrors = true;
                    break;
                }
            }

            if (tabsHaveErrors) {
                //alert("Hiding save button");
                jQuery(".saveButton").hide();                        // Hide save button(s)
                jQuery(".formControls").css("height", "30px");      // Adjust height for missing save button
                jQuery("#messageBox").empty();                      // Hide global messages
            } else {
                //alert("Showing save button");
                jQuery(".saveButton").show();                       // Show save button(s)
                jQuery(".formControls").css("height", "");          // Readjust height for present save button
            }
        }

        function formTabClicked() {
            jQuery("#messageBox").empty(); // Hide global messages
        }

    </script>

</head>

<body>

<s:div id="screen">

    <s:div id="header">
        <div id="headerTopLeft">
            <div class="screenname">
                LaceWiki:&#160;<ui:insert name="screenname"/>
            </div>
        </div>
        <div id="headerTopRight">
            <ui:insert name="headerTopRight"/>
        </div>
        <div id="headerBottomLeft">
            <ui:insert name="headerBottomLeft"/>
        </div>
        <div id="headerBottomRight">
            <ui:insert name="headerBottomRight"/>
        </div>
    </s:div>

    <s:div id="control">
        <div id="controlLeft"><ui:insert name="controlLeft"/></div>
        <div id="controlRight">&#160;
            <h:form id="workspaceSwitcher" rendered="#{wiki:sizeOf(conversationList) > 0}">
                <h:selectOneMenu value="#{switcher.conversationIdOrOutcome}"
                                 styleClass="workspaceSwitcherCombobox">
                    <f:selectItems value="#{switcher.selectItems}"/>
                </h:selectOneMenu>
                <h:commandLink action="#{switcher.select}" accesskey="W"
                             styleClass="linkNavigation">Switch <u>W</u>orkspace</h:commandLink>

            </h:form><ui:insert name="controlRight"/></div>
    </s:div>

    <div id="controlSeparator">&#160;</div>

    <s:div id="sidebar">
        <ui:insert name="sidebar"/>
    </s:div>

    <s:div id="body">
        <s:div id="messageBox" styleClass="messageBox"><j4j:idProxy id="messageBox_"/>
        <s:div rendered="#{!empty facesMessages.currentGlobalMessages}">
            <ui:repeat var="message" value="#{facesMessages.currentGlobalMessages}">
                <h:panelGrid columns="2">
                    <h:graphicImage value="/themes/#{wikiPreferences.themeName}/img/info.gif"
                                    width="18" height="18"
                                    styleClass="infoImage"/>
                    <h:outputText styleClass="infoMessage" value="#{message.summary}"/>
                </h:panelGrid>
                <!-- TODO: Well, how do we do that in EL without static stuff?! #{message.severity == 'Warn' or message.severity == 'Error'}
                <h:panelGrid columns="2" rendered="false">
                    <h:graphicImage value="/themes/#{wikiPreferences.themeName}/img/attention.gif"
                                    width="18" height="18"
                                    styleClass="attentionImage"/>
                    <h:outputText styleClass="attentionMessage" value="#{message.summary}"/>
                </h:panelGrid>
                -->
            </ui:repeat>
        </s:div>
        </s:div>
        <div id="content">
            <ui:insert name="content"/>
        </div>
    </s:div>

    <div id="footer">
        <ui:insert name="footer"/>
        <div align="right" style="font-size:smaller;">
            LaceWiki is using
            <a href="http://www.jboss.com/products/seam">JBoss Seam</a> and
            running on <a href="http://www.jboss.org/products/jbossas">JBoss Application Server</a>.
        </div>
    </div>

    <!-- Remove this to disable Facelets JSF debugging
    <ui:debug hotkey="D"/>
    -->

</s:div>

</body>
</html>
