<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE pages PUBLIC "-//Seam/Seam Pages DTD 1.2//EN" "http://jboss.com/products/seam/pages-1.2.dtd">

<pages login-view-id="/loginRequired.xhtml"
        no-conversation-view-id="/dirDisplay.xhtml">

    <page view-id="/test.xhtml" action="#{browser.prepare}">
        <param name="nodeId" value="#{browser.nodeId}"/>
    </page>

    <page view-id="/display.xhtml" action="#{browser.prepare}">
        <param name="nodeId" value="#{browser.nodeId}"/>

        <!-- End any pending long-running conversation that was propagated into his view -->
        <end-conversation/>

        <navigation>
            <rule if="#{!empty currentDocument}">
                <render view-id="/docDisplay.xhtml"/>
            </rule>
            <rule>
                <render view-id="/dirDisplay.xhtml"/>
            </rule>
        </navigation>
    </page>

    <page view-id="/docDisplay.xhtml" action="#{browser.prepare}">
        <param name="nodeId" value="#{browser.nodeId}"/>

        <!-- End any pending long-running conversation that was propagated into his view -->
        <end-conversation/>

        <navigation>
            <rule if-outcome="createDoc">
                <begin-conversation flush-mode="MANUAL"/>
                <redirect view-id="/docEdit.xhtml">
                    <param name="parentDirId" value="#{currentDirectory.id}"/>
                </redirect>
            </rule>

            <rule if-outcome="editDoc">
                <begin-conversation flush-mode="MANUAL"/>
                <redirect view-id="/docEdit.xhtml">
                    <param name="nodeId"        value="#{currentDocument.id}"/>
                    <param name="parentDirId"   value="#{currentDirectory.id}"/>
                </redirect>
            </rule>

            <rule if-outcome="showHistory">
                <begin-conversation flush-mode="MANUAL"/>
                <out name="currentNode" value="#{currentDocument}"/>
                <redirect view-id="/docHistory.xhtml"/>
            </rule>

            <rule if-outcome="browseDir">
                <render view-id="/dirDisplay.xhtml"/>
            </rule>

        </navigation>

    </page>

    <page view-id="/docEdit.xhtml">
        <description>Edit Document</description>

        <navigation from-action="#{documentHome.remove}">
            <end-conversation/>
            <redirect view-id="/display.xhtml">
                <param name="nodeId" value="#{documentHome.parentDirectory.id}"/>
            </redirect>
        </navigation>

        <navigation>
            <rule if-outcome="uploadFile">
                <begin-conversation nested="true" flush-mode="MANUAL"/>
                <redirect view-id="/fileEdit.xhtml">
                    <param name="parentDirId" value="#{documentHome.parentDirectory.id}"/>
                </redirect>
            </rule>
        </navigation>


    </page>

    <page view-id="/docHistory.xhtml">
        <description>Document History '#{currentNode.name}'</description>

        <navigation>
            <rule if-outcome="rollback">
                <redirect view-id="/docEdit.xhtml">
                    <param name="nodeId"        value="#{currentNode.id}"/>
                    <param name="parentDirId"   value="#{currentNode.parent.id}"/>
                </redirect>
            </rule>
        </navigation>

    </page>

    <page view-id="/dirDisplay.xhtml" action="#{browser.prepare}">
        <param name="nodeId" value="#{browser.nodeId}"/>

        <!-- End any pending long-running conversation that was propagated into his view -->
        <end-conversation/>

        <navigation>
            <rule if-outcome="createDir">
                <begin-conversation flush-mode="MANUAL"/>
                <redirect view-id="/dirEdit.xhtml">
                    <param name="parentDirId" value="#{currentDirectory.id}"/>
                </redirect>
            </rule>
            <rule if-outcome="editDir">
                <begin-conversation flush-mode="MANUAL"/>
                <redirect view-id="/dirEdit.xhtml">
                    <param name="nodeId" value="#{currentDirectory.id}"/>
                    <param name="parentDirId" value="#{currentDirectory.parent.id}"/>
                </redirect>
            </rule>
            <rule if-outcome="createDoc">
                <begin-conversation flush-mode="MANUAL"/>
                <redirect view-id="/docEdit.xhtml">
                    <param name="parentDirId" value="#{currentDirectory.id}"/>
                </redirect>
            </rule>
            <rule if-outcome="uploadFile">
                <begin-conversation flush-mode="MANUAL"/>
                <redirect view-id="/fileEdit.xhtml">
                    <param name="parentDirId" value="#{currentDirectory.id}"/>
                </redirect>
            </rule>
            <rule if-outcome="editFile">
                <begin-conversation flush-mode="MANUAL"/>
                <redirect view-id="/fileEdit.xhtml">
                    <param name="nodeId" value="#{param.fileId}"/>
                    <param name="parentDirId" value="#{currentDirectory.id}"/>
                </redirect>
            </rule>

        </navigation>

    </page>

    <page view-id="/dirEdit.xhtml">
        <description>Edit Directory</description>

        <navigation from-action="#{directoryHome.remove}">
            <rule>
                <end-conversation/>
                <redirect view-id="/dirDisplay.xhtml">
                    <param name="nodeId" value="#{directoryHome.parentDirectory.id}"/>
                </redirect>
            </rule>
        </navigation>

    </page>

    <page view-id="/fileEdit.xhtml">
        <description>Edit File</description>

        <!-- TODO: If this is a nested conversation we really want to exit to the parent view after persist(),
             e.g. editDoc -> uploadFile -> editDoc instead of currently editDoc -> uploadFile -> dirDisplay
             This needs navigation actions or the already required polymorphic exitConversation() feature -->
        <navigation from-action="#{fileHome.remove}">
            <rule>
                <end-conversation/>
                <redirect view-id="/dirDisplay.xhtml">
                    <param name="nodeId" value="#{fileHome.parentDirectory.id}"/>
                </redirect>
            </rule>
        </navigation>

    </page>

    <page view-id="/userAccount.xhtml">
        <description>Managing Member Account</description>
    </page>
    <page view-id="/userProfile.xhtml">
        <description>Managing Member Profile</description>
    </page>
    <page view-id="/userPrefs.xhtml">
        <description>Managing Member Preferences</description>
    </page>
    <page view-id="/userList.xhtml">
        <description>Searching Members (Results: #{userSearch.rowCount})</description>
    </page>
    <page view-id="/adminHome.xhtml">
        <restrict>#{s:hasPermission('User', 'isAdmin', currentUser)}</restrict>
        <description>Administration: Home</description>
    </page>
    <page view-id="/adminRoles.xhtml">
        <restrict>#{s:hasPermission('User', 'isAdmin', currentUser)}</restrict>
        <description>Administration: Roles</description>
    </page>
    <page view-id="/adminPrefs.xhtml">
        <restrict>#{s:hasPermission('User', 'isAdmin', currentUser)}</restrict>
        <description>Administration: Preferences</description>
    </page>
    <page view-id="/userHome.xhtml" action="#{browser.redirectToCurrentUserHome()}"/>

    <!-- Global actions -->

    <page view-id="/*">

        <navigation>

            <!-- Not perfect, but we need to force some re-rendering of the view when users log in or out -->
            <rule if-outcome="loggedIn" if="#{!empty currentUser.memberHome}">
                <redirect view-id="/userHome.xhtml"/>
            </rule>
            <rule if-outcome="loggedIn" if="#{empty currentUser.memberHome}">
                <redirect view-id="/display.xhtml"/>
            </rule>
            <rule if-outcome="loggedOut">
                <end-conversation/>
                <redirect view-id="/display.xhtml"/>
            </rule>

            <rule if-outcome="register">
                <!-- TODO: I don't want to join, I want a new parallel root conversation: http://jira.jboss.com/jira/browse/JBSEAM-944 -->
                <begin-conversation join="true" flush-mode="MANUAL"/>
                <redirect view-id="/userAccount.xhtml"/>
            </rule>
            <rule if-outcome="editCurrentUser">
                <!-- TODO: I don't want to join, I want a new parallel root conversation: http://jira.jboss.com/jira/browse/JBSEAM-944 -->
                <begin-conversation join="true" flush-mode="MANUAL"/>
                <redirect view-id="/userProfile.xhtml">
                    <param name="userId" value="#{currentUser.id}"/>
                </redirect>
            </rule>
            <rule if-outcome="editAccount">
                <begin-conversation join="true" flush-mode="MANUAL"/>
                <redirect view-id="/userAccount.xhtml">
                    <param name="userId" value="#{currentUser.id}"/>
                </redirect>
            </rule>
            <rule if-outcome="editProfile">
                <begin-conversation join="true" flush-mode="MANUAL"/>
                <redirect view-id="/userProfile.xhtml">
                    <param name="userId" value="#{currentUser.id}"/>
                </redirect>
            </rule>

            <rule if-outcome="editPreferences">
                <begin-conversation join="true" flush-mode="MANUAL"/>
                <redirect view-id="/userPrefs.xhtml">
                    <param name="userId" value="#{userHome.instance.id}"/>
                    <param name="visibility" value="#{'USER'}"/>
                </redirect>
            </rule>

            <rule if-outcome="listUsers">
                <!-- TODO: I don't want to join, I want a new parallel root conversation: http://jira.jboss.com/jira/browse/JBSEAM-944 -->
                <begin-conversation join="true" flush-mode="MANUAL"/>
                <redirect view-id="/userList.xhtml"/>
            </rule>

            <rule if-outcome="adminHome">
                <!-- TODO: I don't want to join, I want a new parallel root conversation: http://jira.jboss.com/jira/browse/JBSEAM-944 -->
                <begin-conversation join="true" flush-mode="MANUAL"/>
                <redirect view-id="/adminHome.xhtml"/>
            </rule>
            <rule if-outcome="adminRoles">
                <begin-conversation join="true" flush-mode="MANUAL"/>
                <redirect view-id="/adminRoles.xhtml"/>
            </rule>
            <rule if-outcome="adminPrefs">
                <begin-conversation join="true" flush-mode="MANUAL"/>
                <redirect view-id="/adminPrefs.xhtml">
                    <param name="visibility" value="#{'SYSTEM'}"/>
                </redirect>
            </rule>

            <rule if-outcome="error">
                <redirect view-id="/message.xhtml">
                    <message severity="ERROR">An unrecoverable error occured!</message>
                </redirect>
            </rule>
        </navigation>

    </page>

    <!-- Special pages -->

    <page view-id="/confirmRegistration.xhtml" action="#{authenticator.activate}">
        <navigation>
            <rule if-outcome="activated">
                <redirect view-id="/display.xhtml">
                    <param name="nodeId" value="#{activatedUser.memberHome.id}"/>
                    <message severity="INFO">Your account has been activated, this is your new home page. Login to edit this page.</message>
                </redirect>
            </rule>
            <rule if-outcome="notFound">
                <redirect view-id="/message.xhtml">
                    <message severity="ERROR">Your activation code is invalid.</message>
                </redirect>
            </rule>
        </navigation>
    </page>

    <!-- These effectively "block" the user from navigating forward, he stays on the last browsed page and
         gets an error message. -->
    <page view-id="/loginRequired.xhtml" action="#{browser.redirectToLastBrowsedPageWithConversation}"/>

    <exception class="org.jboss.seam.security.AuthorizationException">
        <end-conversation/>
        <redirect view-id="/message.xhtml">
            <message severity="WARN">Access Denied: #{org.jboss.seam.handledException.message}</message>
        </redirect>
    </exception>

    <!-- Catch all
    <exception>
        <end-conversation/>
        <redirect view-id="/message.xhtml">
            <message severity="ERROR">#{org.jboss.seam.handledException.message}</message>
        </redirect>
    </exception>
     -->
    
</pages>


