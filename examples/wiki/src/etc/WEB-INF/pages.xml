<?xml version="1.0" encoding="UTF-8"?>
<pages xmlns="http://jboss.com/products/seam/pages"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://jboss.com/products/seam/pages http://jboss.com/products/seam/pages-2.0.xsd">

    <page view-id="/wiki.xhtml">
        <param name="nodeId" value="#{wikiRequestResolver.nodeId}"/>
        <param name="areaName" value="#{wikiRequestResolver.areaName}"/>
        <param name="nodeName" value="#{wikiRequestResolver.nodeName}"/>
        <param name="message"   value="#{wikiRequestResolver.message}"/>
        <action execute="#{wikiRequestResolver.resolve}"/>
        <navigation>
            <rule if-outcome="docDisplay">
                <raise-event type="DocumentHome.init"/>
                <render view-id="/docDisplay.xhtml"/>
            </rule>
            <rule if-outcome="dirDisplay">
                <raise-event type="DirectoryHome.init"/>
                <render view-id="/dirDisplay.xhtml"/>
            </rule>
        </navigation>
    </page>

    <page view-id="/docDisplay.xhtml">
        <param name="documentId" value="#{documentHome.nodeId}"/>
        <action execute="#{documentHome.init}"/>
        <navigation>
            <rule if-outcome="missingParameters">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/wiki.xhtml"/>
            </rule>
        </navigation>
    </page>

    <page view-id="/docHistory.xhtml" no-conversation-view-id="/wiki.xhtml">
        <description>Document History</description>
        <param name="nodeId" value="#{nodeHistory.nodeId}"/>
        <action execute="#{nodeHistory.init}"/>
        <begin-conversation flush-mode="MANUAL" join="true"/>
        <navigation>
            <rule if-outcome="exit">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/docDisplay.xhtml">
                    <param name="documentId"          value="#{nodeHistory.currentNode.id}"/>
                </redirect>
            </rule>
            <rule if-outcome="purgedHistory">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/wiki.xhtml">
                    <param name="nodeId"    value="#{nodeHistory.currentNode.id}"/>
                    <param name="message"       value="purgedHistory"/>
                </redirect>
            </rule>

            <rule if-outcome="missingParameters">
                <end-conversation/>
                <redirect view-id="/message.xhtml">
                    <message severity="ERROR">No request parameters specified.</message>
                </redirect>
            </rule>
            <rule if-outcome="rollback">
                <redirect view-id="/docEdit.xhtml">
                    <param name="documentId"          value="#{nodeHistory.currentNode.id}"/>
                    <param name="parentDirectoryId"   value="#{nodeHistory.currentNode.parent.id}"/>
                </redirect>
            </rule>
        </navigation>
    </page>

    <page view-id="/docEdit.xhtml" no-conversation-view-id="/wiki.xhtml">
        <description>#{documentHome.idDefined ? 'Edit Document' : 'Create Document'}</description>
        <param name="documentId" value="#{documentHome.nodeId}"/>
        <param name="parentDirectoryId" value="#{documentHome.parentDirectoryId}"/>
        <action execute="#{documentHome.init}"/>
        <begin-conversation flush-mode="MANUAL" join="true"/>

        <navigation>
            <rule if-outcome="missingParameters">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/wiki.xhtml"/>
            </rule>
            <rule if-outcome="exitManaged">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/docDisplay"/>
            </rule>
            <rule if-outcome="exitUnmanaged">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/dirDisplay.xhtml">
                    <param name="directoryId" value="#{documentHome.parentDirectoryId}"/>
                </redirect>
            </rule>
            <rule if-outcome="removed">
                <end-conversation/>
                <redirect view-id="/dirDisplay.xhtml">
                    <param name="directoryId" value="#{documentHome.parentDirectoryId}"/>
                </redirect>
            </rule>
        </navigation>
    </page>

    <page view-id="/dirDisplay.xhtml">
        <param name="directoryId" value="#{directoryHome.nodeId}"/>
        <action execute="#{directoryHome.init}"/>
        <navigation>
            <rule if-outcome="missingParameters">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/wiki.xhtml"/>
            </rule>
        </navigation>
    </page>

    <page view-id="/dirEdit.xhtml" no-conversation-view-id="/wiki.xhtml">
        <description>#{directoryHome.idDefined ? 'Edit Directory' : 'Create Directory'}</description>
        <param name="directoryId" value="#{directoryHome.nodeId}"/>
        <param name="parentDirectoryId" value="#{directoryHome.parentDirectoryId}"/>
        <action execute="#{directoryHome.init}"/>
        <begin-conversation flush-mode="MANUAL" join="true"/>

        <navigation>
            <rule if-outcome="missingParameters">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/wiki.xhtml"/>
            </rule>
            <rule if-outcome="exitManaged">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/dirDisplay"/>
            </rule>
            <rule if-outcome="exitUnmanaged">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/dirDisplay.xhtml">
                    <param name="directoryId" value="#{directoryHome.parentDirectoryId}"/>
                </redirect>
            </rule>
            <rule if-outcome="removed">
                <end-conversation/>
                <redirect view-id="/dirDisplay.xhtml">
                    <param name="directoryId" value="#{directoryHome.parentDirectoryId}"/>
                </redirect>
            </rule>
        </navigation>
    </page>

    <page view-id="/fileEdit.xhtml" no-conversation-view-id="/wiki.xhtml">
        <description>#{fileHome.idDefined ? 'Edit File' : 'Create File'}</description>
        <param name="fileId" value="#{fileHome.nodeId}"/>
        <param name="parentDirectoryId" value="#{fileHome.parentDirectoryId}"/>
        <action execute="#{fileHome.init}"/>
        <begin-conversation flush-mode="MANUAL" join="true"/>

        <navigation>
            <rule if-outcome="missingParameters">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/wiki.xhtml"/>
            </rule>
            <rule if-outcome="exit">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/dirDisplay.xhtml">
                    <param name="directoryId" value="#{fileHome.parentDirectoryId}"/>
                </redirect>
            </rule>
            <rule if-outcome="removed">
                <end-conversation/>
                <redirect view-id="/dirDisplay.xhtml">
                    <param name="directoryId" value="#{fileHome.parentDirectoryId}"/>
                </redirect>
            </rule>
        </navigation>
    </page>

    <page view-id="/search.xhtml">
        <description>Search (Results: #{searchResult.size})</description>
        <param name="query" value="#{wikiSearch.simpleQuery}"/>
        <begin-conversation flush-mode="MANUAL" join="true"/>
    </page>

    <page view-id="/adminHome.xhtml" no-conversation-view-id="/wiki.xhtml">
        <description>System Administration</description>
        <restrict>#{s:hasPermission('User', 'isAdmin', currentUser)}</restrict>
        <begin-conversation flush-mode="MANUAL" join="true"/>
    </page>

    <page view-id="/userRegister.xhtml" no-conversation-view-id="/wiki.xhtml">
        <description>#{identity.loggedIn ? 'Create Account' : 'Registration'}</description>
        <action execute="#{userHome.init}"/>
        <begin-conversation flush-mode="MANUAL" join="true"/>
        <navigation>
            <rule if-outcome="persisted" if="#{s:hasPermission('User', 'isAdmin', currentUser)}">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/userHome.xhtml">
                    <param name="userId" value="#{userHome.userId}"/>
                </redirect>
            </rule>
            <rule if-outcome="persisted">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/wiki.xhtml"/>
            </rule>
        </navigation>
    </page>

    <page view-id="/userHome.xhtml" no-conversation-view-id="/wiki.xhtml">
        <description>Managing Account: #{userHome.instance.username}</description>
        <param name="userId" value="#{userHome.userId}"/>
        <action execute="#{userHome.init}"/>
        <begin-conversation flush-mode="MANUAL" join="true"/>
        <navigation>
            <rule if-outcome="updatedCurrentCredentials">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/wiki.xhtml">
                    <param name="message" value="updatedCurrentCredentials"/>
                </redirect>
            </rule>
            <rule if-outcome="removed">
                <end-conversation/>
                <redirect view-id="/wiki.xhtml"/>
            </rule>
        </navigation>
    </page>

    <page view-id="/userList.xhtml">
        <description>Member Search (Results: #{userSearch.rowCount})</description>
        <begin-conversation flush-mode="MANUAL" join="true"/>
    </page>

    <page view-id="/confirmRegistration.xhtml" action="#{authenticator.activate}">
        <navigation>
            <rule if-outcome="activated">
                <redirect view-id="/wiki.xhtml">
                    <param name="message" value="accountActivatedPleaseLogin"/>
                </redirect>
            </rule>
            <rule if-outcome="notFound">
                <redirect view-id="/wiki.xhtml">
                    <param name="message" value="invalidActivationCode"/>
                </redirect>
            </rule>
        </navigation>
    </page>

    <page view-id="/*">

        <navigation>

            <!-- Go to start page on logout because the session has been invalidated -->
            <rule if-outcome="loggedOut">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/wiki.xhtml"/>
            </rule>

            <!-- 'search' is a POST submit, turn it into a bookmarkable GET -->
            <rule if-outcome="search">
                <redirect view-id="/search.xhtml"/>
            </rule>

            <rule if-outcome="error">
                <redirect view-id="/message.xhtml">
                    <message severity="ERROR">An unrecoverable error occured!</message>
                </redirect>
            </rule>
        </navigation>

    </page>

    <!-- Mobile browsers get a mini version of the site -->

    <page view-id="/mobile/wiki.xhtml">
        <param name="nodeId" value="#{wikiRequestResolver.nodeId}"/>
        <action execute="#{wikiRequestResolver.resolve}"/>
        <navigation>
            <rule if-outcome="docDisplay">
                <raise-event type="DocumentHome.init"/>
                <render view-id="/mobile/docDisplay.xhtml"/>
            </rule>
            <rule if-outcome="dirDisplay">
                <raise-event type="DirectoryHome.init"/>
                <render view-id="/mobile/dirDisplay.xhtml"/>
            </rule>
        </navigation>
    </page>


    <exception class="org.jboss.seam.framework.EntityNotFoundException">
        <end-conversation/>
        <redirect view-id="/message.xhtml">
            <message severity="ERROR">Entity not found.</message>
        </redirect>
    </exception>

    <exception class="org.jboss.seam.security.AuthorizationException">
        <end-conversation/>
        <redirect view-id="/message.xhtml">
            <message severity="WARN">Access Denied: #{org.jboss.seam.handledException.message}</message>
        </redirect>
    </exception>

    <exception class="javax.persistence.OptimisticLockException">
        <end-conversation/>
        <redirect view-id="/message.xhtml">
            <message severity="ERROR">Someone modified the same record while you were editing it. Please restart your workspace.</message>
        </redirect>
    </exception>

    <!-- This breaks unit tests...
    <exception>
        <redirect view-id="/message.xhtml">
            <message severity="ERROR">Exception: #{org.jboss.seam.exception.message}</message>
        </redirect>
    </exception>
    -->

</pages>


