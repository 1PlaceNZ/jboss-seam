<?xml version="1.0" encoding="UTF-8"?>
<pages xmlns="http://jboss.com/products/seam/pages"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://jboss.com/products/seam/pages http://jboss.com/products/seam/pages-2.0.xsd">

    <page view-id="/wiki.xhtml">
        <param name="nodeId" value="#{wikiRequestResolver.nodeId}"/>
        <param name="areaName" value="#{wikiRequestResolver.areaName}"/>
        <param name="nodeName" value="#{wikiRequestResolver.nodeName}"/>
        <param name="message"   value="#{wikiRequestResolver.message}"/>
        <action execute="#{wikiRequestResolver.resolve}"/>
        <navigation>
            <rule if-outcome="docDisplay">
                <render view-id="/docDisplay_#{skin}.xhtml"/>
            </rule>
            <rule if-outcome="dirDisplay">
                <render view-id="/dirDisplay_#{skin}.xhtml"/>
            </rule>
        </navigation>
    </page>

    <page view-id="/docDisplay*">
        <param name="documentId" value="#{documentHome.nodeId}"/>
        <navigation>
            <rule if-outcome="redirectToDocument">
                <redirect view-id="/wiki.xhtml">
                    <param name="nodeId" value="#{documentHome.instance.id}"/>
                </redirect>
            </rule>
        </navigation>
    </page>

    <page view-id="/docHistory*" no-conversation-view-id="/wiki.xhtml">
        <param name="fileId" value="#{documentHistory.fileId}"/>
        <param name="historicalFileId" value = "#{documentHistory.historicalFileId}"/>
        <action execute="#{documentHistory.init}"/>
        <begin-conversation flush-mode="MANUAL" join="true"/>
        <navigation>
            <rule if-outcome="exit">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/docDisplay_#{skin}.xhtml">
                    <param name="documentId" value="#{documentHistory.currentFile.id}"/>
                </redirect>
            </rule>
            <rule if-outcome="purgedHistory">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/wiki.xhtml">
                    <param name="nodeId"    value="#{documentHistory.currentFile.id}"/>
                    <param name="message"   value="lacewiki.msg.docHistory.PurgedHistory"/>
                </redirect>
            </rule>

            <rule if-outcome="rollback">
                <redirect view-id="/docEdit_#{skin}.xhtml">
                    <param name="documentId"          value="#{documentHistory.currentFile.id}"/>
                    <param name="parentDirectoryId"   value="#{documentHistory.currentFile.parent.id}"/>
                </redirect>
            </rule>
        </navigation>
    </page>

    <page view-id="/docEdit*" no-conversation-view-id="/wiki.xhtml">
        <param name="documentId" value="#{documentHome.nodeId}"/>
        <param name="parentDirectoryId" value="#{documentHome.parentNodeId}"/>
        <action execute="#{documentHome.setEdit(true)}"/>
        <begin-conversation flush-mode="MANUAL" join="true"/>

        <navigation>
            <rule if-outcome="exitManaged">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/docDisplay_#{skin}"/>
            </rule>
            <rule if-outcome="exitUnmanaged">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/dirDisplay_#{skin}.xhtml">
                    <param name="directoryId" value="#{documentHome.parentNodeId}"/>
                </redirect>
            </rule>
            <rule if-outcome="removed">
                <end-conversation/>
                <redirect view-id="/dirDisplay_#{skin}.xhtml">
                    <param name="directoryId" value="#{documentHome.parentNodeId}"/>
                </redirect>
            </rule>
        </navigation>
    </page>

    <page view-id="/dirDisplay*">
        <param name="directoryId" value="#{directoryHome.nodeId}"/>
    </page>

    <page view-id="/dirEdit*" no-conversation-view-id="/wiki.xhtml">
        <param name="directoryId" value="#{directoryHome.nodeId}"/>
        <param name="parentDirectoryId" value="#{directoryHome.parentNodeId}"/>
        <action execute="#{directoryHome.setEdit(true)}"/>
        <begin-conversation flush-mode="MANUAL" join="true"/>

        <navigation>
            <rule if-outcome="exitManaged">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/dirDisplay_#{skin}.xhtml"/>
            </rule>
            <rule if-outcome="exitUnmanaged">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/dirDisplay_#{skin}.xhtml">
                    <param name="directoryId" value="#{directoryHome.parentNodeId}"/>
                </redirect>
            </rule>
            <rule if-outcome="removed">
                <end-conversation/>
                <redirect view-id="/dirDisplay_#{skin}.xhtml">
                    <param name="directoryId" value="#{directoryHome.parentNodeId}"/>
                </redirect>
            </rule>
        </navigation>
    </page>

    <page view-id="/uploadCreate*" no-conversation-view-id="/wiki.xhtml">
        <param name="parentDirectoryId" value="#{uploader.parentDirectoryId}"/>
        <begin-conversation flush-mode="MANUAL" join="true"/>

        <navigation>
            <rule if-outcome="exit">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/dirDisplay_#{skin}.xhtml">
                    <param name="directoryId" value="#{uploader.parentDirectoryId}"/>
                </redirect>
            </rule>
            <rule if-outcome="WikiUpload">
                <redirect view-id="/uploadEdit_#{skin}.xhtml">
                    <param name="parentDirectoryId" value="#{uploader.parentDirectoryId}"/>
                </redirect>
            </rule>
            <rule if-outcome="WikiUploadImage">
                <redirect view-id="/uploadEdit_#{skin}.xhtml">
                    <param name="parentDirectoryId" value="#{uploader.parentDirectoryId}"/>
                </redirect>
            </rule>
        </navigation>
    </page>

    <page view-id="/uploadEdit*" no-conversation-view-id="/wiki.xhtml">
        <param name="uploadId" value="#{uploadHome.nodeId}"/>
        <param name="parentDirectoryId" value="#{uploadHome.parentNodeId}"/>
        <action execute="#{uploadHome.setEdit(true)}"/>
        <begin-conversation flush-mode="MANUAL" join="true"/>

        <navigation>
            <rule if-outcome="exit">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/dirDisplay_#{skin}.xhtml">
                    <param name="directoryId" value="#{uploadHome.parentNodeId}"/>
                </redirect>
            </rule>
            <rule if-outcome="removed">
                <end-conversation/>
                <redirect view-id="/dirDisplay_#{skin}.xhtml">
                    <param name="directoryId" value="#{uploadHome.parentNodeId}"/>
                </redirect>
            </rule>
        </navigation>
    </page>

    <page view-id="/tagDisplay*">
        <param name="tag" value="#{tagQuery.tag}"/>
    </page>

    <page view-id="/search*">
        <param name="query" value="#{wikiSearch.simpleQuery}"/>
        <begin-conversation flush-mode="MANUAL" join="true"/>
    </page>

    <page view-id="/adminHome*" no-conversation-view-id="/wiki.xhtml">
        <restrict>#{s:hasPermission('User', 'isAdmin', currentUser)}</restrict>
        <begin-conversation flush-mode="MANUAL" join="true"/>
    </page>

    <page view-id="/userRegister*" no-conversation-view-id="/wiki.xhtml">
        <action execute="#{userHome.init}"/>
        <begin-conversation flush-mode="MANUAL" join="true"/>
        <navigation>
            <rule if-outcome="persisted" if="#{s:hasPermission('User', 'isAdmin', currentUser)}">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/userHome_#{skin}.xhtml">
                    <param name="userId" value="#{userHome.userId}"/>
                </redirect>
            </rule>
            <rule if-outcome="persisted">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/wiki.xhtml">
                    <param name="message" value="lacewiki.msg.AccountCreatedConfirmationSent"/>
                </redirect>
            </rule>
        </navigation>
    </page>

    <page view-id="/userHome*" no-conversation-view-id="/wiki.xhtml">
        <param name="userId" value="#{userHome.userId}"/>
        <action execute="#{userHome.init}"/>
        <begin-conversation flush-mode="MANUAL" join="true"/>
        <navigation>
            <rule if-outcome="updatedCurrentCredentials">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/wiki.xhtml">
                    <param name="message" value="lacewiki.msg.UpdatedCurrentCredentials"/>
                </redirect>
            </rule>
            <rule if-outcome="removed">
                <end-conversation/>
                <redirect view-id="/wiki.xhtml"/>
            </rule>
        </navigation>
    </page>

    <page view-id="/userInfo*">
        <param name="userId" value="#{userHome.userId}"/>
    </page>

    <page view-id="/userList*">
        <begin-conversation flush-mode="MANUAL" join="true"/>
    </page>

    <page view-id="/confirmRegistration.xhtml" action="#{authenticator.activate}">
        <param name="activationCode" value="#{authenticator.activationCode}"/>
        <navigation>
            <rule if-outcome="activated">
                <redirect view-id="/wiki.xhtml">
                    <param name="message" value="lacewiki.msg.AccountActivatedPleaseLogin"/>
                </redirect>
            </rule>
            <rule if-outcome="notFound">
                <redirect view-id="/wiki.xhtml">
                    <param name="message" value="lacewiki.msg.InvalidActivationCode"/>
                </redirect>
            </rule>
        </navigation>
    </page>

    <page view-id="/resetPassword.xhtml" action="#{userPasswordReset.prepare}">
        <param name="activationCode" value="#{userPasswordReset.activationCode}"/>
        <navigation>
            <rule if-outcome="prepared">
                <redirect view-id="/wiki.xhtml">
                    <param name="message" value="lacewiki.msg.resetPassword.PasswordResetPrepared"/>
                </redirect>
            </rule>
            <rule if-outcome="notFound">
                <redirect view-id="/wiki.xhtml">
                    <param name="message" value="lacewiki.msg.InvalidActivationCode"/>
                </redirect>
            </rule>
        </navigation>
    </page>

    <page view-id="/*">

        <navigation>

            <!-- Go to start page on logout because the session has been invalidated -->
            <rule if-outcome="loggedOut">
                <end-conversation before-redirect="true"/>
                <redirect view-id="/wiki.xhtml"/>
            </rule>

            <!-- 'search' is a POST submit, turn it into a bookmarkable GET -->
            <rule if-outcome="search">
                <redirect view-id="/search_#{skin}.xhtml"/>
            </rule>

            <rule if-outcome="error">
                <redirect view-id="/message.xhtml">
                    <message severity="ERROR">#{messages['lacewiki.msg.FatalError']}</message>
                </redirect>
            </rule>
        </navigation>

    </page>

    <!-- Page descriptions don't support wildcards -->
    <page view-id="/docHistory_d.xhtml">
        <description>#{messages['lacewiki.label.docHistory.DocumentHistory']}</description>
    </page>
    <page view-id="/docEdit_d.xhtml">
        <description>#{documentHome.idDefined
                        ? messages['lacewiki.label.docEdit.EditDocument']
                        : messages['lacewiki.label.docEdit.CreateDocument']}</description>
    </page>
    <page view-id="/dirEdit_d.xhtml">
        <description>#{directoryHome.idDefined
                        ? messages['lacewiki.label.dirEdit.EditDirectory']
                        : messages['lacewiki.label.dirEdit.CreateDirectory']}</description>
    </page>
    <page view-id="/uploadCreate_d.xhtml">
        <description>#{messages['lacewiki.label.upload.UploadFile']}</description>
    </page>
    <page view-id="/uploadEdit_d.xhtml">
        <description>#{uploadHome.idDefined
                        ? messages['lacewiki.label.uploadEdit.EditFile']
                        : messages['lacewiki.label.uploadEdit.UploadFile']}</description>
    </page>
    <page view-id="/search_d.xhtml">
        <description>#{messages['lacewiki.label.search.Search']} (#{messages['lacewiki.label.search.Results']}: #{wikiSearch.searchResult.size})</description>
    </page>
    <page view-id="/adminHome_d.xhtml">
        <description>#{messages['lacewiki.label.adminHome.Administration']}</description>
    </page>
    <page view-id="/userRegister_d.xhtml">
        <description>#{identity.loggedIn
                        ? messages['lacewiki.label.userRegister.CreateNewAccount']
                        : messages['lacewiki.label.userRegister.RegisterNewAccount']}</description>
    </page>
    <page view-id="/userHome_d.xhtml">
        <description>#{messages['lacewiki.label.userHome.EditUser']}: #{userHome.instance.username}</description>
    </page>
    <page view-id="/userList_d.xhtml">
        <description>#{messages['lacewiki.label.userList.MemberList']} (#{messages['lacewiki.label.userList.Results']}: #{userSearch.rowCount})</description>
    </page>


    <page view-id="/docHistory_m.xhtml">
        <description>#{messages['lacewiki.label.docHistory.DocumentHistory']}</description>
    </page>
    <page view-id="/docEdit_m.xhtml">
        <description>#{documentHome.idDefined
                        ? messages['lacewiki.label.docEdit.EditDocument']
                        : messages['lacewiki.label.docEdit.CreateDocument']}</description>
    </page>
    <page view-id="/dirEdit_m.xhtml">
        <description>#{directoryHome.idDefined
                        ? messages['lacewiki.label.dirEdit.EditDirectory']
                        : messages['lacewiki.label.dirEdit.CreateDirectory']}</description>
    </page>
    <page view-id="/uploadCreate_m.xhtml">
        <description>#{messages['lacewiki.label.upload.UploadFile']}</description>
    </page>
    <page view-id="/uploadEdit_m.xhtml">
        <description>#{uploadHome.idDefined
                        ? messages['lacewiki.label.uploadEdit.EditFile']
                        : messages['lacewiki.label.uploadEdit.UploadFile']}</description>
    </page>
    <page view-id="/search_m.xhtml">
        <description>#{messages['lacewiki.label.search.Search']} (#{messages['lacewiki.label.search.Results']}: #{wikiSearch.searchResult.size})</description>
    </page>
    <page view-id="/adminHome_m.xhtml">
        <description>#{messages['lacewiki.label.adminHome.Administration']}</description>
    </page>
    <page view-id="/userRegister_m.xhtml">
        <description>#{identity.loggedIn
                        ? messages['lacewiki.label.userRegister.CreateNewAccount']
                        : messages['lacewiki.label.userRegister.RegisterNewAccount']}</description>
    </page>
    <page view-id="/userHome_m.xhtml">
        <description>#{messages['lacewiki.label.userHome.EditUser']}: #{userHome.instance.username}</description>
    </page>
    <page view-id="/userList_m.xhtml">
        <description>#{messages['lacewiki.label.userList.MemberList']} (#{messages['lacewiki.label.userList.Results']}: #{userSearch.rowCount})</description>
    </page>


    <exception class="javax.faces.application.ViewExpiredException">
        <!-- TODO: This is never thrown by JSF -->
        <redirect view-id="/wiki.xhtml">
            <message>Your session has timed out, please try again</message>
        </redirect>
    </exception>

    <exception class="org.jboss.seam.security.AuthorizationException">
        <end-conversation/>
        <redirect view-id="/wiki.xhtml">
            <message severity="WARN">#{messages['lacewiki.msg.AccessDenied']}: #{org.jboss.seam.handledException.message}</message>
        </redirect>
    </exception>

    <exception class="javax.persistence.OptimisticLockException">
        <end-conversation/>
        <!-- TODO: This fails randomly, it works only once and then we don't get the message anymore?! -->
        <redirect view-id="/message.xhtml">
            <message severity="WARN">#{messages['lacewiki.msg.OptimisticLockError']}</message>
        </redirect>
    </exception>

    <exception class="org.jboss.seam.framework.EntityNotFoundException">
        <end-conversation/>
        <http-error error-code="404"/>
    </exception>

    <!-- TODO: This breaks unit tests...
    <exception>
        <redirect view-id="/message.xhtml">
            <message severity="ERROR">Exception: #{org.jboss.seam.exception.message}</message>
        </redirect>
    </exception>
    -->

</pages>


