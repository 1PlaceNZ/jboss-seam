<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping PUBLIC
        "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
        "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">

<hibernate-mapping>

    <query name="forums">
        select d.id, d
        from
            WikiDirectory d fetch all properties,
            WikiMenuItem m
        where
            d = m.directory
            and d.parent = :parentDir
        order by m.displayPosition asc
    </query>

    <query name="forumsMenuItems">
        select m
        from
            WikiMenuItem m
        where
            m.directory.parent = :parentDir
        order by m.displayPosition asc
    </query>

    <query name="forumTopicCount">
        select
            f.id, count(distinct t)
        from
            WikiDirectory f, WikiDocument t
        where
            f.parent = :parentDir
            and t.parent = f
            and (t.headerMacrosString like '%forumPosting%' or t.headerMacrosString like '%forumStickyPosting%')
        group
            by f.id
    </query>

    <query name="forumReplyCount">
        select
            f.id, count(distinct c)
        from
            WikiDirectory f, WikiDocument t, WikiComment c
        where
            f.parent = :parentDir
            and t.parent = f
            and (t.headerMacrosString like '%forumPosting%' or t.headerMacrosString like '%forumStickyPosting%')
            and c.nodeInfo.nsThread in (select c2.nodeInfo.nsThread from WikiComment c2 where c2.parent = t)
        group
            by f.id
    </query>

    <query name="forumLastTopic">
        select
            f.id, t
        from
            WikiDirectory f, WikiDocument t left join fetch t.parent left join fetch t.createdBy u left join fetch u.profile
        where
            f.parent = :parentDir
            and t.parent = f
            and (t.headerMacrosString like '%forumPosting%' or t.headerMacrosString like '%forumStickyPosting%')
            and t.createdOn = (select max(t2.createdOn) from WikiDocument t2 where t2 = t)
    </query>

    <query name="forumLastReply">
        select
            f.id, c
        from
            WikiDirectory f, WikiDocument t, WikiComment c left join fetch c.parent left join fetch c.createdBy u left join fetch u.profile
        where
            f.parent = :parentDir
            and t.parent = f
            and (t.headerMacrosString like '%forumPosting%' or t.headerMacrosString like '%forumStickyPosting%')
            and c.nodeInfo.nsThread in (select c2 from WikiComment c2 where c2.parent = t)
            and c.createdOn = (
                select max(c3.createdOn) from WikiDirectory f2, WikiDocument t2, WikiComment c3
                where f2.parent = :parentDir and t2.parent = f2
                and (t2.headerMacrosString like '%forumPosting%' or t2.headerMacrosString like '%forumStickyPosting%')
                and c3.nodeInfo.nsThread in (select c4.nodeInfo.nsThread from WikiComment c4 where c4.parent = t2)
            )
    </query>

    <query name="forumUnreadTopics"><![CDATA[
        select
            distinct t.id, t.parent.id
        from
            WikiDirectory f, WikiDocument t
        where
            f.parent = :parentDir
            and t.parent = f
            and (t.headerMacrosString like '%forumPosting%' or t.headerMacrosString like '%forumStickyPosting%')
            and t.createdOn > :lastLoginDate
    ]]></query>

    <query name="forumUnreadReplies"><![CDATA[
        select
            distinct t.id, t.parent.id
        from
            WikiDirectory f, WikiDocument t, WikiComment c
        where
            f.parent = :parentDir
            and t.parent = f
            and (t.headerMacrosString like '%forumPosting%' or t.headerMacrosString like '%forumStickyPosting%')
            and c.nodeInfo.nsThread in (select c2.nodeInfo.nsThread from WikiComment c2 where c2.parent = t)
            and c.createdOn > :lastLoginDate
    ]]></query>

    <query name="forumUnreadTopicsInForum"><![CDATA[
        select
            distinct t.id, t.parent.id
        from
            WikiDocument t
        where
            t.parent = :parentDir
            and (t.headerMacrosString like '%forumPosting%' or t.headerMacrosString like '%forumStickyPosting%')
            and t.createdOn > :lastLoginDate
    ]]></query>

    <query name="forumUnreadRepliesInForum"><![CDATA[
        select
            distinct t.id, t.parent.id
        from
            WikiDocument t, WikiComment c
        where
            t.parent = :parentDir
            and (t.headerMacrosString like '%forumPosting%' or t.headerMacrosString like '%forumStickyPosting%')
            and c.nodeInfo.nsThread in (select c2.nodeInfo.nsThread from WikiComment c2 where c2.parent = t)
            and c.createdOn > :lastLoginDate
    ]]></query>

    <query name="forumTopicsCount">
        select count(t) from WikiDocument t
        where t.parent = :parentDir
        and (t.headerMacrosString like '%forumPosting%' or t.headerMacrosString like '%forumStickyPosting%')
    </query>


    <!-- TODO: HQL doesn't support CASE...WHEN or arbitrary OUTER JOINs  -->
    <!-- TODO: We could optimize this a little if we'd also retrieve the CREATED_BY_USER_ID guy but
               we'll hit the 2nd level cache anyway or we load them in batches... -->
    <sql-query name="forumTopics">
        <return class="org.jboss.seam.wiki.core.model.WikiDocument"/>
        <return-scalar column="STICKY" type="integer"/>
        <return-scalar column="HAS_REPLIES" type="boolean"/>
        <return-scalar column="LAST_POST" type="timestamp"/>
        <![CDATA[
        select distinct
            doc2.NODE_ID as NODE_ID,
            doc2.OBJ_VERSION as OBJ_VERSION,
            doc2.RATING as RATING,
            doc2.AREA_NR as AREA_NR,
            doc2.NAME as NAME,
            doc2.WIKINAME as WIKINAME,
            doc2.CREATED_ON as CREATED_ON,
            doc2.CREATED_BY_USER_ID as CREATED_BY_USER_ID,
            doc2.LAST_MODIFIED_ON as LAST_MODIFIED_ON,
            doc2.LAST_MODIFIED_BY_USER_ID as LAST_MODIFIED_BY_USER_ID,
            doc2.WRITE_ACCESS_LEVEL as WRITE_ACCESS_LEVEL,
            doc2.READ_ACCESS_LEVEL as READ_ACCESS_LEVEL,
            doc2.WRITE_PROTECTED as WRITE_PROTECTED,
            doc2.PARENT_NODE_ID as PARENT_NODE_ID,

            doc1.FILE_REVISION as FILE_REVISION,

            doc0.NAME_AS_TITLE as NAME_AS_TITLE,
            doc0.ENABLE_COMMENTS as ENABLE_COMMENTS,
            doc0.ENABLE_COMMENT_FORM as ENABLE_COMMENT_FORM,
            doc0.ENABLE_COMMENTS_ON_FEEDS as ENABLE_COMMENTS_ON_FEEDS,
            doc0.HEADER as HEADER,
            doc0.HEADER_MACROS as HEADER_MACROS,
            doc0.CONTENT_MACROS as CONTENT_MACROS,
            doc0.FOOTER as FOOTER,
            doc0.FOOTER_MACROS as FOOTER_MACROS,

            case when (doc0.HEADER_MACROS like '%forumStickyPosting%') then 1 else 0 end as STICKY,
            case when c0.CREATED_ON is null then false else true end as HAS_REPLIES,
            case when c0.CREATED_ON is null then doc2.CREATED_ON else c0.CREATED_ON end as LAST_POST

        from
            WIKI_DOCUMENT doc0 inner join WIKI_FILE doc1 on doc0.NODE_ID=doc1.NODE_ID inner join WIKI_NODE doc2 on doc0.NODE_ID=doc2.NODE_ID
           left outer join WIKI_NODE c0
           on c0.NODE_ID in (select c1.NODE_ID from WIKI_COMMENT c1 where c1.NS_THREAD in
                                (select c2.NS_THREAD from WIKI_COMMENT c2 inner join WIKI_NODE c3 on c3.NODE_ID = c2.NODE_ID where c3.PARENT_NODE_ID = doc0.NODE_ID)
                            )
           and c0.CREATED_ON = (select max(c5.CREATED_ON) from WIKI_COMMENT c4 inner join WIKI_NODE c5 on c4.NODE_ID = c5.NODE_ID where c4.NS_THREAD in
                                    (select c6.NS_THREAD from WIKI_COMMENT c6 inner join WIKI_NODE c7 on c6.NODE_ID = c7.NODE_ID where c7.PARENT_NODE_ID = doc0.NODE_ID)
                                )
        where
            doc2.PARENT_NODE_ID = :parentNodeId
            and (doc0.HEADER_MACROS like '%forumPosting%' or doc0.HEADER_MACROS like '%forumStickyPosting%')
        order
            by STICKY desc, LAST_POST desc
    ]]></sql-query>

    <query name="forumTopicsReplies"><![CDATA[
        select
            t.id,
            count(c),
            c2
        from
            WikiDocument t,
            WikiComment c,
            WikiComment c2 join fetch c2.createdBy u
        where
            t.id in (:topicIds)
            and c.nodeInfo.nsThread in (select c3.nodeInfo.nsThread from WikiComment c3 where c3.parent = t)
            and c2.createdOn =
                (select max(c4.createdOn) from WikiComment c4 where c4.nodeInfo.nsThread in
                    (select c5.nodeInfo.nsThread from WikiComment c5 where c5.parent = t) )
        group by
            t.id,

            c2.id, c2.nodeInfo.nsLeft, c2.nodeInfo.nsRight, c2.nodeInfo.nsThread,
            c2.version, c2.parent,
            c2.areaNumber, c2.name, c2.wikiname, c2.createdBy, c2.createdOn, c2.lastModifiedBy, c2.lastModifiedOn, c2.readAccessLevel, c2.writeAccessLevel, c2.writeProtected,
            c2.subject, c2.fromUserName, c2.fromUserEmail, c2.fromUserHomepage, c2.useWikiText,

            u.id, u.version, u.firstname, u.lastname, u.username, u.passwordHash, u.email, u.activated, u.activationCode, u.createdOn, u.lastLoginOn, u.memberHome, u.profile

    ]]></query>

    <!-- TODO: HQL doesn't support FROM clause subselect -->
    <sql-query name="forumPostersAndRatingPoints">
        <return class="org.jboss.seam.wiki.core.model.User"/>
        <return-scalar column="RATING_POINTS" type="long"/>
        <![CDATA[
        select
            ur.USER_ID, ur.ACTIVATED, ur.ACTIVATION_CODE, ur.CREATED_ON, ur.EMAIL, ur.FIRSTNAME, ur.LAST_LOGIN_ON,
            ur.LASTNAME, ur.MEMBER_HOME_WIKI_DIRECTORY_ID, ur.PASSWORDHASH, ur.USER_PROFILE_ID, ur.USERNAME, ur.OBJ_VERSION,
            sum(ur.RATING) as RATING_POINTS
        from
           (select distinct
                user2.*,
                com2.NODE_ID,
                com2.RATING
            from
                WIKI_DOCUMENT doc0
                 inner join WIKI_FILE doc1 on doc0.NODE_ID=doc1.NODE_ID
                  inner join WIKI_NODE doc2 on doc0.NODE_ID=doc2.NODE_ID,
                WIKI_COMMENT com1
                 inner join WIKI_NODE com2 on com1.NODE_ID=com2.NODE_ID
                  inner join USERS user2 on com2.CREATED_BY_USER_ID=user2.USER_ID
                   inner join USER_ROLE roles1 on user2.USER_ID=roles1.USER_ID
                    inner join ROLES roles2 on roles1.ROLE_ID=roles2.ROLE_ID
            where
                doc2.PARENT_NODE_ID=:parentDirId
                and (com1.NS_THREAD in
                      (select com3.NS_THREAD from WIKI_COMMENT com3
                         inner join WIKI_NODE com4 on com3.NODE_ID=com4.NODE_ID
                         where com4.PARENT_NODE_ID=doc0.NODE_ID
                      )
                     )
                and (roles2.NAME not in (:ignoreUserInRoles))
                and com2.RATING<>0
            ) as ur
        group by
            ur.USER_ID, ur.ACTIVATED, ur.ACTIVATION_CODE, ur.CREATED_ON, ur.EMAIL, ur.FIRSTNAME, ur.LAST_LOGIN_ON,
            ur.LASTNAME, ur.MEMBER_HOME_WIKI_DIRECTORY_ID, ur.PASSWORDHASH, ur.USER_PROFILE_ID, ur.USERNAME,
            ur.OBJ_VERSION
        order by sum(ur.RATING) desc
    ]]></sql-query>

</hibernate-mapping>