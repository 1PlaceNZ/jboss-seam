<!--

  CavetEmptor ANT build script.

-->

<project name="CaveatEmptor" default="junit" basedir=".">

    <!-- Name of project and version -->
    <property name="proj.name"      value="CaveatEmptor"/>
    <property name="proj.shortname" value="caveatemptor"/>
    <property name="version"        value="0.1"/>

	<!-- Global properties for this build -->
	<property name="src.java.dir"   value="src/java"/>
	<property name="lib.dir"        value="lib"/>
	<property name="build.dir"      value="build"/>
	<property name="classes.dir"    value="${build.dir}/webapp/WEB-INF/classes"/>
    <property name="test.out.dir"   value="${basedir}/testout"/>

	<!-- Classpath declaration -->
	<path id="lib.classpath">
		<fileset dir="${lib.dir}">
			<include name="**/*.jar"/>
            <include name="**/*.zip"/>
		</fileset>
	</path>

    <!-- Useful shortcuts -->
	<patternset id="meta.files">
		<include name="**/*.xml"/>
		<include name="**/*.properties"/>
	</patternset>

	<!-- Tasks -->

	<taskdef name="junit" classname="org.apache.tools.ant.taskdefs.optional.junit.JUnitTask">
		<classpath refid="lib.classpath"/>
	</taskdef>

	<taskdef name="junitreport" classname="org.apache.tools.ant.taskdefs.optional.junit.XMLResultAggregator">
		<classpath refid="lib.classpath"/>
	</taskdef>

	<taskdef name="schemaexport" classname="org.hibernate.tool.hbm2ddl.SchemaExportTask">
		<classpath refid="lib.classpath"/>
		<classpath path="${classes.dir}"/>
	</taskdef>


	<!-- Targets -->

	<target name="clean" description="Cleans up build and dist directories">
		<delete dir="${build.dir}"/>
        <delete dir="${test.out.dir}"/>
        <delete>
            <fileset dir="${basedir}" includes="caveatemptor.*"/>
        </delete>

	</target>

	<target name="compiletest" depends="clean" description="Compile the tests">
		<mkdir dir="${classes.dir}"/>
		<javac
			srcdir="${src.java.dir}"
			destdir="${classes.dir}"
			nowarn="on">
			<classpath refid="lib.classpath"/>
		</javac>

		<!-- Copy over the mapping files -->
		<copy todir="${classes.dir}">
			<fileset dir="${src.java.dir}">
				<patternset refid="meta.files"/>
			</fileset>
		</copy>

	</target>

	<target name="junit" depends="compiletest" description="Run the test suite">
        <mkdir dir="${test.out.dir}"/>
		<junit printsummary="yes" fork="yes" haltonfailure="yes">
            <classpath refid="lib.classpath"/>
			<classpath>
				<pathelement path="${classes.dir}"/>
			</classpath>
			<formatter type="plain"/>
			<test name="org.hibernate.ce.auction.test.AllTests" todir="${test.out.dir}" haltonfailure="no"/>
		</junit>
	</target>

	<target name="exportddl" depends="compiletest" description="Export the DDL to caveatemptor.ddl">
		<schemaexport   config="${classes.dir}/hibernate.cfg.xml"
						quiet="yes"
						text="yes"
						output="${basedir}/caveatemptor.ddl"
						delimiter=";"/>
	</target>

    <target name="dbunit.template">
        <style basedir="${src.java.dir}/org/hibernate/ce/auction/model"
               destdir="${basedir}"
               style="${src.java.dir}/org/hibernate/ce/auction/test/dbunit.xsl">
            <mapper type="glob" from="*.hbm.xml" to="*.data.xml"/>
		    <include name="**/*.hbm.xml"/>
        </style>
    </target>

    <target name="war" description="Copy files to create War file">
	     <jar destfile="${build.dir}/${proj.shortname}.war">
    	     <zipfileset dir="${lib.dir}" prefix="WEB-INF/lib">
    	     	<include name="*.jar"/>
    	     </zipfileset>
   	         <zipfileset dir="src/resources/WEB-INF" prefix="WEB-INF"/>
    	     <zipfileset dir="src/resources/jsp"/>
    	     <zipfileset dir="${classes.dir}" prefix="WEB-INF/classes"/>
    	 </jar>
    </target>
</project>
