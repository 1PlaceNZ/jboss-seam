<?xml version="1.0"?>

<project name="@projectName@" default="deploy" basedir=".">

	<!-- Give user a chance to override without editing this file or typing -D -->
	<property file="${basedir}/build.properties" />

	<!-- set global properties for this build -->
	<property name="dist.dir" value="dist" />
	<property name="classes.dir" value="exploded-archives/@projectName@.jar" />
	<property name="src.java.dir" value="src" />
	<property name="lib.dir" value="lib" />
	<property name="ear.dir" value="exploded-archives/@projectName@.ear" />
	<property name="jar.dir" value="exploded-archives/@projectName@.jar" />
	<property name="war.dir" value="exploded-archives/@projectName@.war" />
	<property name="test.dir" value="build/test" />
	<property name="embedded-ejb3.dir" value="${basedir}/embedded-ejb/conf" />
	<property name="deploy.dir" value="${jboss.home}/server/default/deploy" />
	<property name="testng.jar" value="${basedir}/lib/testng-4.5.1-jdk15.jar" />
	<property name="javac.debug" value="true" />
	<property name="javac.deprecation" value="false" />

	<fileset id="lib" dir="${lib.dir}">
		<include name="*.jar" />
	</fileset>

	<path id="build.classpath">
		<fileset refid="lib" />
	</path>

	<target name="init" description="Initialize the build">
		<mkdir dir="${classes.dir}" />
		<mkdir dir="${dist.dir}" />
		<mkdir dir="${ear.dir}" />
		<mkdir dir="${war.dir}" />
	</target>

	<target name="compile" depends="init" description="Compile the Java source code">
		<javac classpathref="build.classpath" destdir="${classes.dir}" debug="${javac.debug}" deprecation="${javac.deprecation}" nowarn="on">
			<src path="${src.java.dir}" />
		</javac>
	</target>

	<target name="build-jar" depends="compile" description="Build the distribution .jar file">
		<copy todir="${classes.dir}">
			<fileset dir="${basedir}/resources">
				<include name="seam.properties" />
				<include name="import.sql" />
			</fileset>
		</copy>
		<copy todir="${classes.dir}/META-INF">
			<fileset dir="${basedir}/resources/META-INF">
				<include name="ejb-jar.xml" />
				<include name="persistence.xml" />
			</fileset>
		</copy>
		<jar jarfile="${ear.dir}/@projectName@.jar" basedir="${classes.dir}">
			<include name="**/*" />
			<manifest>
				<attribute name="@projectName@" value="Seam Generated Application" />
			</manifest>
		</jar>
	</target>

	<target name="build-war" depends="compile" description="Build the distribution .war file">
		<copy todir="${basedir}/exploded-archives/@projectName@.war">
			<fileset dir="${basedir}/view" />
		</copy>
		<copy todir="${basedir}/exploded-archives/@projectName@.war/WEB-INF/lib">
			<fileset dir="${lib.dir}">
				<include name="jsf-facelets.jar" />
				<include name="jboss-seam-ui.jar" />
				<include name="jboss-seam-debug.jar" />
			</fileset>
		</copy>
		<copy todir="${basedir}/exploded-archives/@projectName@.war/WEB-INF">
			<fileset dir="${basedir}/resources/WEB-INF" />
            <filterset>
                <filter token="jndiPattern" value="@projectName@/#{ejbName}/local"/>
                <filter token="embeddedEjb" value="false"/>
            </filterset>
		</copy>
		<copy todir="${basedir}/exploded-archives/MyDomain.war/WEB-INF/classes">
			<fileset dir="${basedir}/resources"> 
				<include name="messages*.properties"/>
			</fileset>
		</copy>
	</target>

	<target name="build-ear" depends="build-jar,build-war" description="Build the EAR">
		<copy todir="${basedir}/exploded-archives/@projectName@.ear">
			<fileset dir="${basedir}/resources">
				<include name="*jpdl.xml" />
				<include name="hibernate.cfg.xml" />
				<include name="jbpm.cfg.xml" />
			</fileset>
			<fileset dir="${lib.dir}">
				<include name="jboss-seam.jar" />
				<include name="jbpm*.jar" />
				<include name="el-*.jar" />
			</fileset>
		</copy>
		<copy todir="${basedir}/exploded-archives/@projectName@.ear/META-INF">
			<fileset dir="${basedir}/resources/META-INF">
				<include name="application.xml" />
				<include name="jboss-app.xml" />
			</fileset>
		</copy>
		<zip destfile="exploded-archives/@projectName@.ear/@projectName@.war" basedir="${war.dir}" update="true" />
		<ear basedir="${ear.dir}" appxml="${ear.dir}/META-INF/application.xml" destfile="${dist.dir}/@projectName@.ear" />
	</target>

	<target name="deploy" depends="build-ear" description="Deploy to JBoss">
		<fail unless="jboss.home">jboss.home MUST be set. Update build.properties to point to a valid JBoss installation.</fail>
		<copy todir="${deploy.dir}">
			<fileset dir="${basedir}/resources">
				<include name="@projectName@-ds.xml" />
			</fileset>
		</copy>
		<copy todir="${deploy.dir}" file="${dist.dir}/@projectName@.ear" />
	</target>

	<target name="undeploy" description="Undeploy the example from JBoss">
		<delete file="${deploy.dir}/@projectName@.ear" />
		<delete file="${deploy.dir}/@projectName@-ds.xml" />
	</target>

	<target name="clean" description="Cleans up the build directory">
		<delete dir="${test.dir}" />
		<delete dir="${dist.dir}" />
		<delete dir="${classes.dir}" />
		<delete dir="${ear.dir}" />
		<delete dir="${war.dir}" />
		<delete dir="${jar.dir}" />
	</target>

	<target name="test" depends="build-ear" description="Test registration module">

		<taskdef resource="testngtasks" classpath="${testng.jar}" />
		<copy todir="${test.dir}">
			<fileset dir="${basedir}/resources" />
			<fileset dir="${jar.dir}" />
		</copy>

		<copy todir="${test.dir}/WEB-INF">
			<fileset dir="${war.dir}/WEB-INF">
				<exclude name="**/*.jar" />
			</fileset>
		</copy>

		<copy todir="${test.dir}" flatten="true">
			<fileset dir="${src.java.dir}">
				<include name="**/*Test.xml" />
			</fileset>
		</copy>

		<testng outputdir="${basedir}/testng-report">
			<classpath path="${test.dir}" />
			<classpath path="${embedded-ejb3.dir}" />
			<classpath refid="build.classpath" />
			<xmlfileset dir="${test.dir}" includes="*Test.xml" />
		</testng>
	</target>
</project>
